---
phase: 06-browser-identity-and-bootstrapping
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/db/src/schema/identities.ts
  - packages/db/src/schema/credentials.ts
  - packages/db/src/schema/credential-audit.ts
  - packages/db/src/schema/index.ts
  - packages/db/drizzle.config.ts
  - packages/browser/package.json
  - packages/browser/tsconfig.json
  - packages/browser/src/index.ts
  - packages/browser/src/manager.ts
  - packages/browser/src/session.ts
  - packages/browser/src/stealth.ts
  - packages/browser/src/captcha.ts
  - pnpm-workspace.yaml
autonomous: true
requirements:
  - BROWSER-05
  - IDENT-03
  - IDENT-06

must_haves:
  truths:
    - "identities, identity_accounts, credentials, and credential_access_audit tables exist in Postgres after db:push"
    - "pgcrypto extension is enabled and pgp_sym_encrypt/pgp_sym_decrypt work in the database"
    - "@jarvis/browser package compiles and exports BrowserManager and BrowserSession"
    - "BrowserManager can launch a headless Chromium browser and create per-identity BrowserContexts with proxy isolation"
  artifacts:
    - path: "packages/db/src/schema/identities.ts"
      provides: "identities + identity_accounts tables"
      contains: "identities"
    - path: "packages/db/src/schema/credentials.ts"
      provides: "credentials table with bytea encrypted_value column"
      contains: "credentials"
    - path: "packages/db/src/schema/credential-audit.ts"
      provides: "credential_access_audit table"
      contains: "credentialAccessAudit"
    - path: "packages/browser/src/manager.ts"
      provides: "BrowserManager singleton managing Playwright lifecycle"
      exports: ["BrowserManager"]
    - path: "packages/browser/src/session.ts"
      provides: "BrowserSession with per-identity BrowserContext isolation"
      exports: ["BrowserSession"]
  key_links:
    - from: "packages/browser/src/stealth.ts"
      to: "playwright-extra"
      via: "chromium.use(stealthPlugin())"
      pattern: "chromium\\.use"
    - from: "packages/db/src/schema/credentials.ts"
      to: "pgcrypto"
      via: "bytea column type for encrypted storage"
      pattern: "customType.*bytea"
---

<objective>
Create the foundational database schemas for identity management and encrypted credential vault, plus the @jarvis/browser package for Playwright lifecycle management with stealth capabilities.

Purpose: All subsequent Phase 6 plans depend on these schemas (identity tools need identity/credential tables) and this package (browser tools need BrowserManager/BrowserSession). This is the shared foundation that enables parallel development of identity and browser tool groups.

Output: 4 new DB schema tables, pgcrypto extension, @jarvis/browser package with BrowserManager/BrowserSession/stealth/captcha modules.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-browser-identity-and-bootstrapping/06-RESEARCH.md
@packages/db/src/schema/goals.ts
@packages/db/src/schema/index.ts
@packages/db/drizzle.config.ts
@packages/db/src/index.ts
@packages/db/package.json
@pnpm-workspace.yaml
@packages/wallet/package.json
@packages/wallet/tsconfig.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create identity and credential database schemas with pgcrypto</name>
  <files>
    packages/db/src/schema/identities.ts
    packages/db/src/schema/credentials.ts
    packages/db/src/schema/credential-audit.ts
    packages/db/src/schema/index.ts
    packages/db/drizzle.config.ts
  </files>
  <action>
Create three new schema files in packages/db/src/schema/:

**identities.ts** — Contains BOTH the `identities` and `identity_accounts` tables (co-locate to avoid cross-file FK issues with drizzle-kit CJS bundler, same pattern as goals.ts co-locating sub_goals):

`identities` table:
- id: uuid PK with defaultRandom()
- name: text NOT NULL (faker-generated full name)
- email: text NOT NULL (temp email used for creation)
- persona: jsonb NOT NULL (full backstory, phone, address, DOB, bio, jobTitle, username — everything faker generates)
- profilePictureUrl: text (nullable — URL to AI-generated face or randomuser.me)
- status: text NOT NULL default 'active' (active/suspended/retired/archived — per locked identity lifecycle decision)
- riskScore: integer NOT NULL default 0
- createdAt: timestamp with timezone NOT NULL defaultNow()
- retiredAt: timestamp with timezone (nullable)
- notes: text (nullable)

`identityAccounts` table:
- id: uuid PK with defaultRandom()
- identityId: uuid NOT NULL references identities(id)
- service: text NOT NULL (e.g., 'twitter', 'github', 'stripe')
- username: text (nullable)
- status: text NOT NULL default 'active' (active/suspended/banned/deleted)
- purpose: text NOT NULL (why this account was created — per IDENT-06 requirement)
- metadata: jsonb (nullable — service-specific extra data)
- createdAt: timestamp with timezone NOT NULL defaultNow()

Export: identities, identityAccounts

**credentials.ts** — Encrypted credential vault:

`credentials` table:
- id: uuid PK with defaultRandom()
- identityId: uuid (nullable) references identities(id) — NULL = operator-provided credential (per locked decision: credentials are identity-scoped, NULL for operator creds)
- service: text NOT NULL
- key: text NOT NULL (e.g., 'password', 'api_key', 'oauth_token')
- encryptedValue: use customType to define a bytea column (CRITICAL: must be bytea, NOT text — pgcrypto output is raw binary, text would corrupt it). The customType maps to SQL type 'bytea' and handles serialization/deserialization as Buffer.
- status: text NOT NULL default 'active' (active/rotated/expired)
- createdAt: timestamp with timezone NOT NULL defaultNow()
- expiresAt: timestamp with timezone (nullable)

Export: credentials

**credential-audit.ts** — Access audit trail:

`credentialAccessAudit` table:
- id: uuid PK with defaultRandom()
- credentialId: uuid NOT NULL references credentials(id)
- accessedBy: text NOT NULL (tool name or 'agent-loop')
- purpose: text NOT NULL (why accessed — from agent context)
- identityId: uuid (nullable — denormalized for fast dashboard queries)
- accessedAt: timestamp with timezone NOT NULL defaultNow()

Export: credentialAccessAudit

**Update packages/db/src/schema/index.ts**: Add the three new barrel exports:
```
export * from './identities.js';
export * from './credentials.js';
export * from './credential-audit.js';
```

**Update packages/db/drizzle.config.ts**: Add the three new schema files to the schema array:
```
'./src/schema/identities.ts',
'./src/schema/credentials.ts',
'./src/schema/credential-audit.ts',
```

**Update packages/db/src/index.ts**: Re-export the new schema symbols so downstream packages can import them from @jarvis/db.

After creating schemas, run:
1. `pnpm --filter @jarvis/db run build` to verify compilation
2. `pnpm --filter @jarvis/db run db:push` to push schema to Postgres
3. Verify pgcrypto: run a raw SQL query via the db client to execute `CREATE EXTENSION IF NOT EXISTS pgcrypto` then test `SELECT pgp_sym_encrypt('test', 'testkey', 'cipher-algo=aes256')` succeeds

IMPORTANT: Use `import { sql } from 'drizzle-orm'` inside @jarvis/db (it IS a direct dep here). For the bytea customType, use Drizzle's customType from 'drizzle-orm/pg-core'.
  </action>
  <verify>
1. `pnpm --filter @jarvis/db run build` exits 0
2. `pnpm --filter @jarvis/db run db:push` exits 0 (tables created)
3. Run a verification script: `pnpm --filter @jarvis/db exec tsx -e "import { db } from './src/index.js'; import { sql } from 'drizzle-orm'; const r = await db.execute(sql\`SELECT pgp_sym_decrypt(pgp_sym_encrypt('hello', 'key123', 'cipher-algo=aes256')::bytea, 'key123') as val\`); console.log(r.rows[0]); process.exit(0);"` — should print { val: 'hello' }
4. `pnpm --filter @jarvis/db exec tsx -e "import { identities, identityAccounts, credentials, credentialAccessAudit } from './src/schema/index.js'; console.log('identities:', identities._.name); console.log('identityAccounts:', identityAccounts._.name); console.log('credentials:', credentials._.name); console.log('credentialAccessAudit:', credentialAccessAudit._.name); process.exit(0);"` — prints all 4 table names
  </verify>
  <done>
Four new tables (identities, identity_accounts, credentials, credential_access_audit) exist in Postgres. pgcrypto extension enabled and pgp_sym_encrypt/decrypt verified working. All schema symbols exported from @jarvis/db. Build passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create @jarvis/browser package with Playwright lifecycle, stealth, and CAPTCHA</name>
  <files>
    packages/browser/package.json
    packages/browser/tsconfig.json
    packages/browser/src/index.ts
    packages/browser/src/manager.ts
    packages/browser/src/session.ts
    packages/browser/src/stealth.ts
    packages/browser/src/captcha.ts
    pnpm-workspace.yaml
  </files>
  <action>
Create a new `packages/browser/` directory as the @jarvis/browser workspace package.

**package.json**: Follow the same structure as packages/wallet/package.json:
- name: "@jarvis/browser"
- version: "0.0.0"
- private: true
- type: "module"
- main: "dist/index.js"
- types: "dist/index.d.ts"
- scripts: { "build": "tsc", "dev": "tsc --watch" }
- dependencies: playwright, playwright-extra, puppeteer-extra-plugin-stealth, @2captcha/captcha-solver
- devDependencies: @jarvis/typescript-config, typescript

**tsconfig.json**: Extend @jarvis/typescript-config/base.json. Set outDir: "dist", rootDir: "src", composite: true (follow wallet package pattern).

**stealth.ts**: Export a function `getStealthChromium()` that:
1. Imports chromium from 'playwright-extra'
2. Imports StealthPlugin from 'puppeteer-extra-plugin-stealth'
3. Calls chromium.use(StealthPlugin()) only once (guard with a boolean flag to prevent double-use)
4. Returns the chromium instance
NOTE: playwright-extra's import may vary — check that `import { chromium } from 'playwright-extra'` works. If it doesn't compile, try `import playwright from 'playwright-extra'` and use `playwright.chromium`. The research says to import chromium directly.

**manager.ts**: BrowserManager class:
- Private `browser: Browser | null = null`
- `async launch()`: launches headless Chromium via getStealthChromium().launch({ headless: true, args: ['--no-sandbox', '--disable-setuid-sandbox', '--disable-dev-shm-usage'] }). Store reference. Return browser.
- `async getBrowser()`: lazy — calls launch() if browser is null, returns existing otherwise
- `async close()`: calls browser?.close(), sets to null
- `isRunning()`: returns browser !== null
- Export as named export (NOT singleton — let consumer manage lifecycle)

**session.ts**: BrowserSession class:
- Constructor takes: `{ manager: BrowserManager, identityId: string, proxy?: { server: string; username?: string; password?: string }, storageStatePath?: string, userAgent?: string, viewport?: { width: number; height: number }, locale?: string, timezoneId?: string }`
- `async open()`: calls manager.getBrowser(), then browser.newContext({ proxy, storageState: storageStatePath if file exists else undefined, viewport: viewport ?? { width: 1280, height: 720 }, userAgent, locale: locale ?? 'en-US', timezoneId: timezoneId ?? 'America/New_York' }). Stores context. Returns this.
- `async newPage()`: calls context.newPage(), returns page
- `async saveState(path: string)`: calls context.storageState({ path }). Returns path.
- `async close()`: calls context?.close(), sets to null
- `getContext()`: returns context (for advanced use)
- Export BrowserSession and its options type

**captcha.ts**: CaptchaSolver class:
- Constructor takes: `{ apiKey?: string }` — if no apiKey, solver is disabled (agent will escalate to operator)
- `isAvailable()`: returns true if apiKey was provided
- `async solveRecaptchaV2(pageUrl: string, siteKey: string): Promise<string>`: uses @2captcha/captcha-solver Solver.recaptcha({ pageurl, googlekey })
- `async solveHCaptcha(pageUrl: string, siteKey: string): Promise<string>`: uses solver.hcaptcha({ pageurl, sitekey })
- `async solveTurnstile(pageUrl: string, siteKey: string): Promise<string>`: uses solver.turnstile({ pageurl, sitekey })
- All methods throw if apiKey not set (with helpful message: "CAPTCHA_API_KEY not configured — set TWO_CAPTCHA_API_KEY env var or escalate to operator")
- Export CaptchaSolver

**index.ts**: Barrel export all public APIs:
```typescript
export { BrowserManager } from './manager.js';
export { BrowserSession, type BrowserSessionOptions } from './session.js';
export { getStealthChromium } from './stealth.js';
export { CaptchaSolver } from './captcha.js';
```

**pnpm-workspace.yaml**: No change needed — `packages/*` glob already covers packages/browser.

After creating files:
1. Run `pnpm install` to link the new workspace package
2. Install Chromium browser binary: `pnpm --filter @jarvis/browser exec npx playwright install chromium`
3. Run `pnpm --filter @jarvis/browser run build` to verify compilation
  </action>
  <verify>
1. `pnpm --filter @jarvis/browser run build` exits 0
2. `ls packages/browser/dist/index.js packages/browser/dist/manager.js packages/browser/dist/session.js packages/browser/dist/stealth.js packages/browser/dist/captcha.js` — all 5 files exist
3. Verify Chromium installed: `pnpm --filter @jarvis/browser exec npx playwright install chromium --dry-run` or check `~/.cache/ms-playwright/` for chromium directory
  </verify>
  <done>
@jarvis/browser package compiles. BrowserManager, BrowserSession, getStealthChromium, and CaptchaSolver are all exported. Playwright Chromium binary is installed. Package is linked in the monorepo workspace.
  </done>
</task>

</tasks>

<verification>
1. `pnpm --filter @jarvis/db run build && pnpm --filter @jarvis/browser run build` — both packages compile
2. Four new tables exist in Postgres: identities, identity_accounts, credentials, credential_access_audit
3. pgcrypto encrypt/decrypt round-trip verified
4. @jarvis/browser dist/ contains all 5 compiled JS files
</verification>

<success_criteria>
- All 4 schema tables created in Postgres and accessible via @jarvis/db exports
- pgcrypto extension enabled with working encrypt/decrypt
- @jarvis/browser package compiles with BrowserManager, BrowserSession, stealth plugin, and CaptchaSolver
- Chromium browser binary installed for Playwright
</success_criteria>

<output>
After completion, create `.planning/phases/06-browser-identity-and-bootstrapping/06-01-SUMMARY.md`
</output>
