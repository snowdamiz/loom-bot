---
phase: 05-web-dashboard
plan: 03
type: execute
wave: 3
depends_on: ["05-02"]
files_modified:
  - apps/dashboard/client/src/components/ActivityTab.tsx
  - apps/dashboard/client/src/components/ActivityFeed.tsx
  - apps/dashboard/client/src/components/ActivityEntry.tsx
  - apps/dashboard/client/src/hooks/useActivityFeed.ts
  - apps/dashboard/client/src/App.tsx
autonomous: true
requirements:
  - DASH-02
  - DASH-07

must_haves:
  truths:
    - "Operator can page through activity entries in reverse chronological order"
    - "Activity entries show compact one-liner summaries by default"
    - "Clicking an entry expands to show full details (inputs, outputs, duration, cost)"
    - "Type filters narrow the feed to specific entry types (tool calls, decisions, wallet, planning)"
    - "Text search filters entries by matching content"
    - "New entries appear at the top via SSE without manual refresh"
    - "Decision log entries show LLM reasoning when expanded"
  artifacts:
    - path: "apps/dashboard/client/src/components/ActivityTab.tsx"
      provides: "Activity tab container with search and filters"
      min_lines: 40
    - path: "apps/dashboard/client/src/components/ActivityFeed.tsx"
      provides: "Paginated feed with load-more and live entries"
      min_lines: 50
    - path: "apps/dashboard/client/src/components/ActivityEntry.tsx"
      provides: "Expandable activity entry component"
      min_lines: 40
    - path: "apps/dashboard/client/src/hooks/useActivityFeed.ts"
      provides: "TanStack Query infinite query for cursor pagination"
      min_lines: 30
  key_links:
    - from: "apps/dashboard/client/src/hooks/useActivityFeed.ts"
      to: "/api/activity"
      via: "TanStack useInfiniteQuery"
      pattern: "useInfiniteQuery.*api/activity"
    - from: "apps/dashboard/client/src/components/ActivityFeed.tsx"
      to: "apps/dashboard/client/src/hooks/useSSE.ts"
      via: "SSE activity events prepended to feed"
      pattern: "onActivity|activity"
    - from: "apps/dashboard/client/src/components/ActivityEntry.tsx"
      to: "decision_log.reasoning"
      via: "expanded detail view"
      pattern: "reasoning|decision"
---

<objective>
Build the Activity feed tab with cursor-paginated entries, type filters, text search, live SSE updates, and expandable detail view including decision log reasoning.

Purpose: This is the operator's detailed view into every agent action. The compact default view lets them scan quickly, while expand-on-click reveals full context including LLM reasoning for decisions. Live streaming means the feed is always current.

Output: Fully functional Activity tab with pagination, filters, search, live updates, and decision log display.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-web-dashboard/05-RESEARCH.md
@.planning/phases/05-web-dashboard/05-01-SUMMARY.md
@.planning/phases/05-web-dashboard/05-02-SUMMARY.md

@apps/dashboard/src/routes/activity.ts
@apps/dashboard/client/src/App.tsx
@apps/dashboard/client/src/hooks/useSSE.ts
@apps/dashboard/client/src/lib/api.ts
@apps/dashboard/client/src/App.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Activity feed hook + feed component with pagination and filters</name>
  <files>
    apps/dashboard/client/src/hooks/useActivityFeed.ts
    apps/dashboard/client/src/components/ActivityTab.tsx
    apps/dashboard/client/src/components/ActivityFeed.tsx
  </files>
  <action>
    **Activity feed hook (`client/src/hooks/useActivityFeed.ts`):**
    - Export `useActivityFeed(options: { type?: string; search?: string })`:
      - Use `useInfiniteQuery` from `@tanstack/react-query`
      - queryKey: `['activity-feed', type, search]` -- changes in type/search reset the feed
      - queryFn: calls `apiJson<{ rows: ActivityItem[]; nextCursor: number | null }>('/api/activity?...')` with cursor, limit (50), type, and search as query params
      - `getNextPageParam`: return `lastPage.nextCursor` (null stops infinite loading)
      - `initialPageParam`: undefined (no cursor = start from latest)
      - Return the query result + a flat `entries` array derived from `data.pages.flatMap(p => p.rows)`
    - Define `ActivityItem` type:
      - `id: number`
      - `type: 'tool_call' | 'decision' | 'wallet' | 'planning'`
      - `timestamp: string` (ISO date)
      - `summary: string` (one-liner for compact view)
      - `details: Record<string, unknown>` (full data for expanded view)
      - Note: the API returns raw rows from different tables. The hook should normalize them into this common shape. If the API doesn't normalize, do it in the hook's select/transform.

    **Activity tab (`client/src/components/ActivityTab.tsx`):**
    - Top section: filter bar with:
      - Type filter: row of pill/chip buttons -- "All", "Tool Calls", "Decisions", "Wallet", "Planning"
      - Active filter gets a filled/highlighted style, others outlined
      - Text search: input field with magnifying glass icon (SVG inline), debounced 300ms
      - Clear search button (x icon) when search text is present
    - Below filters: `<ActivityFeed />` component
    - Pass `type` and `search` state to `useActivityFeed` hook
    - Layout: full-width within the tab content area, no grid needed (vertical list)
    - Empty state: "No activity yet" message when feed is empty (not just loading)

    **Activity feed (`client/src/components/ActivityFeed.tsx`):**
    - Receives entries from `useActivityFeed` hook + SSE live entries
    - **Live entries section:** New entries from SSE appear at the top with a subtle highlight animation (fade-in or slide-down). These are separate from paginated entries to avoid cursor confusion.
    - **Paginated entries:** List of `<ActivityEntry />` components (built in Task 2)
    - **Load more:** "Load more" button at the bottom (not infinite scroll -- explicit control). Calls `fetchNextPage()`. Disabled when `!hasNextPage` or `isFetchingNextPage`. Shows loading spinner when fetching.
    - **Loading state:** Skeleton entries (3-4 gray placeholder rows) on initial load
    - **Error state:** Error message with retry button

    **SSE integration:**
    - The parent `App.tsx` already has the SSE connection. Activity SSE events should be passed down to ActivityFeed (via props, context, or by having App.tsx manage a `liveEntries` state array that gets prepended with new SSE activity events).
    - When a new SSE activity event arrives, prepend it to `liveEntries` state. Cap `liveEntries` at 50 items (older ones get dropped; they'll appear in paginated results on next refetch).
    - Live entries get a visual indicator (subtle left border accent or "NEW" badge that fades after 5 seconds)

    **Grouping by goal (per locked decision):**
    - If entries have a `goalId` or `subGoalId` field, group consecutive entries under a collapsible goal header showing the goal description
    - If no goal context available on an entry, show it ungrouped
    - Grouping is a visual enhancement -- if implementation is complex, use a simple approach: show goal ID as a subtle label above related entries, not a full tree structure
  </action>
  <verify>
    Run `pnpm --filter @jarvis/dashboard-client exec tsc --noEmit` to verify compilation. With both servers running, navigate to Activity tab:
    1. Feed loads with entries (or empty state if DB is empty)
    2. Type filter buttons highlight when clicked and filter the feed
    3. Search input filters entries (with debounce)
    4. "Load more" button loads additional pages
  </verify>
  <done>
    Activity tab displays paginated entries with type filters and text search. Feed loads from API with cursor pagination, "Load more" loads additional pages. Filter and search controls work.
  </done>
</task>

<task type="auto">
  <name>Task 2: Expandable activity entries + decision log reasoning + App.tsx wiring</name>
  <files>
    apps/dashboard/client/src/components/ActivityEntry.tsx
    apps/dashboard/client/src/App.tsx
  </files>
  <action>
    **Activity entry component (`client/src/components/ActivityEntry.tsx`):**
    - **Compact view (default):** Single line showing:
      - Type icon (small inline SVG or emoji): wrench for tool_calls, brain for decisions, wallet for wallet txs, cycle for planning
      - Timestamp (relative: "2m ago", "1h ago", or absolute if >24h)
      - Short summary text (tool name + status, decision text, tx amount, etc.)
      - Duration badge if available (e.g., "142ms")
      - Cost badge if available (e.g., "$0.003")
      - Expand chevron (down arrow) on the right
    - **Expanded view (on click):** Slides open below the compact line with:
      - Full input/output data formatted as readable JSON or key-value pairs
      - For tool_calls: tool name, input params, output result, duration, error (if any)
      - For decisions: decision text, full reasoning (JSONB from `decision_log.reasoning`), alternatives considered, confidence
      - For wallet: transaction hash, from/to addresses, amount, token, purpose, status
      - For planning: cycle description, status, duration
      - Collapsible JSON viewer for raw data (click "Show raw" to toggle)
    - Click again to collapse back to compact view
    - Expand/collapse uses CSS transition (max-height or similar) for smooth animation

    **Decision log reasoning display (DASH-07):**
    - When an activity entry is type 'decision' and has `reasoning` field:
      - Show reasoning as formatted text (not raw JSON)
      - If reasoning is an object with `steps` array, render each step as a numbered list
      - If reasoning is a string, render as a paragraph
      - If reasoning is any other shape, render as formatted JSON
    - Visual treatment: reasoning block has a subtle left border (like a blockquote) and slightly different background color (very light blue-gray)

    **App.tsx wiring updates:**
    - Update the existing `App.tsx` to:
      - Remove the Activity tab stub/placeholder
      - Import and render `<ActivityTab />` when Activity tab is active
      - Pass live SSE activity entries to `<ActivityTab />`:
        - Add `liveEntries` state in App.tsx: `useState<ActivityItem[]>([])`
        - SSE `onActivity` callback: prepend new entry to `liveEntries`, cap at 50
        - Pass `liveEntries` and `clearLiveEntries` as props to ActivityTab
      - When switching TO the Activity tab, don't clear live entries (user might want to see what accumulated)
      - When SSE reconnects after disconnect, clear `liveEntries` (stale) and refetch queries

    **Visual polish (both tasks):**
    - Entry rows have subtle bottom border separator (1px #e5e7eb)
    - Hover state on entries: very subtle background color change (#f9fafb)
    - Expanded content indented with padding-left
    - Timestamps in muted gray color (#6b7280)
    - Badges (duration, cost) in small rounded pills with neutral background
    - Error entries highlighted with subtle red-tinted background or red left border
    - Wallet transaction entries show amount prominently

    **Relative time formatting:**
    - Implement a simple `timeAgo(dateString)` utility:
      - < 1 min: "just now"
      - < 60 min: "Xm ago"
      - < 24 hours: "Xh ago"
      - >= 24 hours: format as "Feb 18, 14:30"
    - No external library needed for this simple case
  </action>
  <verify>
    With both servers running and some test data in the database (tool_calls, decision_log entries):
    1. Activity entries show as compact one-liners with icon, timestamp, summary
    2. Clicking an entry expands to show full details
    3. Clicking again collapses it
    4. Decision entries show LLM reasoning in the expanded view
    5. New SSE entries appear at the top with subtle highlight
    6. Type filters correctly show only entries of that type
    7. Tab switching between Overview and Activity works smoothly
  </verify>
  <done>
    Activity entries are expandable with full detail views. Decision log entries show LLM reasoning. Live SSE entries appear at the top of the feed. App.tsx correctly wires SSE data to the Activity tab. All DASH-02 and DASH-07 requirements are satisfied.
  </done>
</task>

</tasks>

<verification>
1. `pnpm --filter @jarvis/dashboard-client exec tsc --noEmit` passes
2. Activity tab shows paginated entries in reverse chronological order
3. Type filter pills filter the feed (Tool Calls, Decisions, Wallet, Planning, All)
4. Text search filters entries with debounce
5. Clicking an entry expands it to show full details (inputs, outputs, duration, cost)
6. Decision log entries show LLM reasoning in expanded view
7. "Load more" button fetches next page via cursor pagination
8. New SSE activity events appear at the top without refresh
9. Tab switching between Overview and Activity works
</verification>

<success_criteria>
- Activity feed displays paginated entries with expand-on-click detail
- Type filters and text search narrow the feed
- Decision log reasoning is displayed for decision entries
- Live SSE entries appear at the top in real time
- Cursor pagination works with "Load more" button
- UI follows the clean, minimal, card-based aesthetic
</success_criteria>

<output>
After completion, create `.planning/phases/05-web-dashboard/05-03-SUMMARY.md`
</output>
