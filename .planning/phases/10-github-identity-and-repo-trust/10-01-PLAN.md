---
phase: 10-github-identity-and-repo-trust
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/db/src/schema/setup-state.ts
  - packages/db/src/schema/github-oauth-state.ts
  - packages/db/src/schema/index.ts
  - .env.example
  - .env.docker.example
  - README.md
autonomous: true
requirements:
  - SEXT-02
  - SEXT-03
user_setup:
  - service: github-oauth-app
    why: Register OAuth credentials used by setup wizard code exchange
    env_vars:
      - name: GITHUB_OAUTH_CLIENT_ID
        source: GitHub OAuth App settings -> Client ID
      - name: GITHUB_OAUTH_CLIENT_SECRET
        source: GitHub OAuth App settings -> Client Secret
      - name: GITHUB_OAUTH_REDIRECT_URI
        source: Callback URL configured on the same OAuth App

must_haves:
  truths:
    - "Setup state can persist verified GitHub user identity and trusted repository metadata."
    - "OAuth state and PKCE verifier values are persisted server-side with expiration and one-time-use semantics."
    - "GitHub OAuth credentials are configured via environment variables and documented for operators."
  artifacts:
    - path: "packages/db/src/schema/setup-state.ts"
      provides: "Schema fields for GitHub identity, trusted repository, and token credential reference"
      contains: "github_repo_full_name"
    - path: "packages/db/src/schema/github-oauth-state.ts"
      provides: "Short-lived OAuth state + PKCE verifier persistence table"
      contains: "oauth_state"
    - path: "packages/db/src/schema/index.ts"
      provides: "Barrel export for the new OAuth state schema"
      pattern: "github-oauth-state"
  key_links:
    - from: "packages/db/src/schema/github-oauth-state.ts"
      to: "packages/db/src/schema/index.ts"
      via: "schema export for dashboard route imports"
      pattern: "github-oauth-state"
    - from: ".env.example"
      to: "apps/dashboard/src/routes/setup.ts"
      via: "GitHub OAuth env var names match runtime lookup"
      pattern: "GITHUB_OAUTH_"
---

<objective>
Create the persistence and configuration foundation for real GitHub trust onboarding.

Purpose: Replace placeholder setup fields with durable identity/repo metadata storage and one-time OAuth challenge persistence so callback validation is trustworthy.
Output: New DB schema support for OAuth challenge state + repo trust data, plus operator-facing env/config documentation.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/10-github-identity-and-repo-trust/10-RESEARCH.md
@packages/db/src/schema/setup-state.ts
@packages/db/src/schema/identities.ts
@packages/db/src/schema/index.ts
@apps/dashboard/src/routes/setup.ts
@.env.example
@.env.docker.example
@README.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add DB schema support for OAuth challenge state and GitHub trust metadata</name>
  <files>
    packages/db/src/schema/setup-state.ts
    packages/db/src/schema/github-oauth-state.ts
    packages/db/src/schema/index.ts
  </files>
  <action>
1. Extend `setup_state` schema with fields required for verified trust:
   - GitHub identity: `githubUserId`, `githubUsername` (retain existing username field if compatible and migrate naming safely).
   - Repository binding: `githubRepoId`, `githubRepoFullName`, `githubRepoDefaultBranch`, `githubRepoValidatedAt`.
   - Token reference: `githubTokenCredentialId` (UUID reference to `credentials.id`).
2. Add a new `oauth_state` table in `packages/db/src/schema/github-oauth-state.ts`:
   - Fields should cover one-time flow integrity: `stateHash`, `codeVerifier`, optional `returnTo`, `expiresAt`, `consumedAt`, `createdAt`.
   - Enforce uniqueness on state hash and include expiration metadata for callback rejection of stale state.
3. Export the new schema module from `packages/db/src/schema/index.ts`.
4. Keep schema style aligned with current Drizzle conventions in this repo (timestamp defaults, types, naming).
  </action>
  <verify>
    - `pnpm build --filter @jarvis/db` succeeds.
    - `rg -n "oauth_state|githubRepoFullName|githubTokenCredentialId" packages/db/src/schema` returns expected schema definitions.
  </verify>
  <done>Database schema can represent OAuth challenge lifecycle, verified GitHub identity, and trusted repository metadata without plaintext token storage.</done>
</task>

<task type="auto">
  <name>Task 2: Document OAuth operator configuration and required env vars</name>
  <files>
    .env.example
    .env.docker.example
    README.md
  </files>
  <action>
1. Add required/optional GitHub OAuth environment variables:
   - `GITHUB_OAUTH_CLIENT_ID`
   - `GITHUB_OAUTH_CLIENT_SECRET`
   - `GITHUB_OAUTH_REDIRECT_URI`
2. Update setup documentation to explain:
   - The callback URL to configure in GitHub OAuth app settings.
   - That setup wizard now performs real OAuth exchange and repository binding.
   - Secret-handling expectations (no plaintext tokens in app logs).
3. Keep naming and formatting consistent with existing env/README sections.
  </action>
  <verify>
    - `rg -n "GITHUB_OAUTH_CLIENT_ID|GITHUB_OAUTH_CLIENT_SECRET|GITHUB_OAUTH_REDIRECT_URI" .env.example .env.docker.example README.md` returns all three files.
  </verify>
  <done>Operators can configure GitHub OAuth from documented env vars with clear callback and security expectations.</done>
</task>

<task type="auto">
  <name>Task 3: Apply and compile schema changes locally</name>
  <files>
    packages/db/src/schema/setup-state.ts
    packages/db/src/schema/github-oauth-state.ts
  </files>
  <action>
1. Run `pnpm db:push` to apply schema updates to the configured database.
2. Re-run `pnpm build --filter @jarvis/db` after push.
3. If `db:push` cannot run in environment, document blocker and keep plan executable by preserving schema correctness.
  </action>
  <verify>
    - `pnpm db:push` succeeds (or explicit blocker captured in summary if DB unavailable).
    - `pnpm build --filter @jarvis/db` succeeds after schema push attempt.
  </verify>
  <done>Schema changes are applied (or clearly blocked by environment), and DB package compiles cleanly.</done>
</task>

</tasks>

<verification>
- `pnpm build --filter @jarvis/db`
- `pnpm db:push`
- Confirm new schema exports are reachable from `@jarvis/db`
</verification>

<success_criteria>
The codebase has a concrete persistence model for OAuth state + GitHub trust metadata, and operators have documented env configuration for OAuth setup.
</success_criteria>

<output>
After completion, create `.planning/phases/10-github-identity-and-repo-trust/10-01-SUMMARY.md`
</output>
