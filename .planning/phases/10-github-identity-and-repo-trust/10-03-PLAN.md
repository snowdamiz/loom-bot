---
phase: 10-github-identity-and-repo-trust
plan: 03
type: execute
wave: 3
depends_on:
  - 10-02
files_modified:
  - apps/dashboard/src/routes/setup.ts
  - apps/dashboard/client/src/components/SetupStepGitHub.tsx
  - apps/dashboard/client/src/components/SetupWizard.tsx
  - apps/dashboard/client/src/hooks/useSetupState.ts
  - packages/tools/src/self-extension/tool-writer.ts
  - packages/tools/src/self-extension/index.ts
  - apps/agent/src/index.ts
  - packages/tools/src/self-extension/github-trust-guard.ts
autonomous: true
requirements:
  - SEXT-02
  - SEXT-04
must_haves:
  truths:
    - "Operator can bind a repository only after successful GitHub identity connection and server-side permission validation."
    - "Setup wizard marks GitHub setup complete only when repository trust binding is persisted."
    - "Built-in self-modification path rejects execution when GitHub identity/binding prerequisites are missing."
  artifacts:
    - path: "apps/dashboard/src/routes/setup.ts"
      provides: "Repository list + bind endpoints with server-side GitHub validation"
      pattern: "/github/repos"
    - path: "apps/dashboard/client/src/components/SetupStepGitHub.tsx"
      provides: "Connect + repository binding UX"
      contains: "Bind Repository"
    - path: "packages/tools/src/self-extension/github-trust-guard.ts"
      provides: "Shared trust precondition checker for builtin tool modifications"
      exports: ["assertGitHubTrustForBuiltinModify"]
    - path: "packages/tools/src/self-extension/tool-writer.ts"
      provides: "Enforced guard before builtinModify staging path"
      pattern: "assertGitHubTrustForBuiltinModify"
  key_links:
    - from: "apps/dashboard/client/src/components/SetupStepGitHub.tsx"
      to: "apps/dashboard/src/routes/setup.ts"
      via: "repo list and bind API calls"
      pattern: "/api/setup/github/repos"
    - from: "packages/tools/src/self-extension/tool-writer.ts"
      to: "packages/tools/src/self-extension/github-trust-guard.ts"
      via: "precondition enforcement before stageBuiltinChange"
      pattern: "builtinModify"
    - from: "packages/tools/src/self-extension/index.ts"
      to: "apps/agent/src/index.ts"
      via: "factory signature update to pass DB/trust dependencies"
      pattern: "createSelfExtensionTools"
---

<objective>
Complete repository trust binding and enforce SEXT-04 gating in self-modification tooling.

Purpose: Ensure connected GitHub identity is tied to an explicit validated repository and prevent built-in code mutations without this trust anchor.
Output: Repo binding API + setup wizard UI updates + tool_write built-in guard with fail-closed behavior.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/10-github-identity-and-repo-trust/10-RESEARCH.md
@.planning/phases/10-github-identity-and-repo-trust/10-02-PLAN.md
@apps/dashboard/src/routes/setup.ts
@apps/dashboard/client/src/components/SetupStepGitHub.tsx
@apps/dashboard/client/src/components/SetupWizard.tsx
@apps/dashboard/client/src/hooks/useSetupState.ts
@packages/tools/src/self-extension/tool-writer.ts
@packages/tools/src/self-extension/index.ts
@apps/agent/src/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add repository listing and binding endpoints with permission validation</name>
  <files>
    apps/dashboard/src/routes/setup.ts
  </files>
  <action>
1. Add endpoint to list accessible repositories for the connected identity (for example `GET /api/setup/github/repos`), backed by GitHub API (`/user/repos`) with pagination-safe defaults.
2. Add bind endpoint (for example `POST /api/setup/github/bind`) that:
   - Accepts selected `owner/repo` (or repo id).
   - Validates repository via GitHub API (`GET /repos/{owner}/{repo}`).
   - Enforces trust threshold (`permissions.push` or `permissions.admin` true).
   - Persists canonical repo trust fields in `setup_state`.
3. Update setup completion logic so GitHub step is complete only when identity is connected and repo binding exists.
4. Return operator-meaningful errors for permission failures and missing access.
  </action>
  <verify>
    - `pnpm build --filter @jarvis/dashboard` succeeds.
    - Binding endpoint rejects repos without required access and accepts a repo with write/admin access.
    - `GET /api/setup` reflects bound repo fields after successful bind.
  </verify>
  <done>Repository trust binding is server-validated and persisted, and setup completion now depends on a real bound repository.</done>
</task>

<task type="auto">
  <name>Task 2: Update setup wizard UI for connect-and-bind flow</name>
  <files>
    apps/dashboard/client/src/components/SetupStepGitHub.tsx
    apps/dashboard/client/src/components/SetupWizard.tsx
    apps/dashboard/client/src/hooks/useSetupState.ts
  </files>
  <action>
1. Replace the current connect/skip stub behavior with a real flow:
   - Trigger OAuth start endpoint and browser redirect.
   - After callback return, refresh setup state and show repository binding UI.
2. Render repository selection sourced from backend endpoint and submit binding to API.
3. Remove or disable “Skip for Now” path for GitHub trust setup in this milestone.
4. Keep UX resilient:
   - loading and error states for connect/list/bind actions,
   - clear empty-state messaging when no writable repos are available.
  </action>
  <verify>
    - `pnpm build --filter @jarvis/dashboard-client` succeeds.
    - Manual wizard flow: connect -> choose repo -> bind -> dashboard unlock.
    - `SetupState` type compiles with new repo-binding fields.
  </verify>
  <done>Setup wizard enforces real GitHub connect + repository binding before setup completion.</done>
</task>

<task type="auto">
  <name>Task 3: Enforce built-in modification trust gate in self-extension tooling</name>
  <files>
    packages/tools/src/self-extension/github-trust-guard.ts
    packages/tools/src/self-extension/tool-writer.ts
    packages/tools/src/self-extension/index.ts
    apps/agent/src/index.ts
  </files>
  <action>
1. Add `github-trust-guard.ts` helper that checks preconditions for built-in modification:
   - GitHub identity connected,
   - repo binding exists,
   - active GitHub token credential reference exists.
2. Integrate guard into `tool_write` built-in path before `stageBuiltinChange()` and fail closed with deterministic error when trust is incomplete.
3. Update `createSelfExtensionTools` signatures/wiring as needed so guard has DB access without introducing brittle globals.
4. Keep non-builtin tool creation path unchanged.
  </action>
  <verify>
    - `pnpm build --filter @jarvis/tools` succeeds.
    - `pnpm build --filter @jarvis/agent` succeeds.
    - Simulated `builtinModify=true` call without binding returns guard rejection before branch staging begins.
  </verify>
  <done>SEXT-04 is enforced in runtime tool path: built-in modifications are blocked unless GitHub trust requirements are satisfied.</done>
</task>

</tasks>

<verification>
- `pnpm build --filter @jarvis/dashboard`
- `pnpm build --filter @jarvis/dashboard-client`
- `pnpm build --filter @jarvis/tools`
- `pnpm build --filter @jarvis/agent`
- Manual happy-path and fail-closed checks for repo binding and builtinModify guard
</verification>

<success_criteria>
Repository trust is explicitly bound and validated in setup UX/API, and the built-in self-modification path now enforces a fail-closed GitHub trust gate.
</success_criteria>

<output>
After completion, create `.planning/phases/10-github-identity-and-repo-trust/10-03-SUMMARY.md`
</output>
