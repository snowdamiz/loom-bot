---
phase: 10-github-identity-and-repo-trust
plan: 02
type: execute
wave: 2
depends_on:
  - 10-01
files_modified:
  - apps/dashboard/src/app.ts
  - apps/dashboard/src/routes/setup.ts
  - apps/dashboard/src/routes/github-oauth-callback.ts
  - apps/dashboard/src/routes/github-oauth-helpers.ts
autonomous: true
requirements:
  - SEXT-01
  - SEXT-02
  - SEXT-03
must_haves:
  truths:
    - "Setup wizard initiates a real GitHub OAuth authorization code flow with server-managed state and PKCE."
    - "OAuth callback rejects invalid/expired/replayed state and exchanges valid code for an access token."
    - "Connected GitHub identity is revalidated from GitHub API and persisted with encrypted token storage."
  artifacts:
    - path: "apps/dashboard/src/routes/setup.ts"
      provides: "Authenticated setup endpoints for starting OAuth flow and reading setup state"
      pattern: "/github/start"
    - path: "apps/dashboard/src/routes/github-oauth-callback.ts"
      provides: "Public callback route that validates state and completes OAuth exchange"
      pattern: "github/callback"
    - path: "apps/dashboard/src/routes/github-oauth-helpers.ts"
      provides: "Shared helper functions for PKCE, OAuth exchange, and identity fetch"
      exports: ["createPkceChallenge", "exchangeOAuthCode", "fetchAuthenticatedUser"]
  key_links:
    - from: "apps/dashboard/src/routes/setup.ts"
      to: "packages/db/src/schema/github-oauth-state.ts"
      via: "persist state + code verifier before redirect"
      pattern: "oauthState"
    - from: "apps/dashboard/src/routes/github-oauth-callback.ts"
      to: "packages/db/src/schema/identities.ts"
      via: "store GitHub token in credentials table"
      pattern: "credentials"
---

<objective>
Implement the real GitHub OAuth identity connection flow in the dashboard backend.

Purpose: Replace stubbed GitHub setup with authenticated identity proof, anti-forgery validation, and encrypted token persistence.
Output: Start endpoint, callback route, helper module, and setup-state responses backed by real OAuth exchanges.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/10-github-identity-and-repo-trust/10-RESEARCH.md
@.planning/phases/10-github-identity-and-repo-trust/10-01-PLAN.md
@apps/dashboard/src/app.ts
@apps/dashboard/src/routes/setup.ts
@packages/db/src/schema/setup-state.ts
@packages/db/src/schema/github-oauth-state.ts
@packages/db/src/schema/identities.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement OAuth start endpoint with state and PKCE persistence</name>
  <files>
    apps/dashboard/src/routes/setup.ts
    apps/dashboard/src/routes/github-oauth-helpers.ts
  </files>
  <action>
1. Add authenticated endpoint `POST /api/setup/github/start` that:
   - Validates required OAuth env vars.
   - Generates strong random `state` and PKCE verifier/challenge (`S256`).
   - Persists one-time challenge in `oauth_state` with strict expiration (for example 10 minutes).
   - Returns the full GitHub authorize URL (`https://github.com/login/oauth/authorize`) with required query params.
2. Ensure state is hashed before persistence so raw state values are not stored directly.
3. Add helper utilities for PKCE generation and URL construction in `github-oauth-helpers.ts` to keep route handlers concise/testable.
  </action>
  <verify>
    - `pnpm build --filter @jarvis/dashboard` succeeds.
    - `curl -s -X POST http://localhost:${DASHBOARD_PORT:-3001}/api/setup/github/start ...` returns URL containing `login/oauth/authorize`, `state`, and `code_challenge_method=S256`.
  </verify>
  <done>Backend can securely initiate OAuth with one-time state + PKCE and produce a valid GitHub authorization URL.</done>
</task>

<task type="auto">
  <name>Task 2: Implement public callback exchange, identity revalidation, and encrypted token persistence</name>
  <files>
    apps/dashboard/src/app.ts
    apps/dashboard/src/routes/github-oauth-callback.ts
    apps/dashboard/src/routes/github-oauth-helpers.ts
    apps/dashboard/src/routes/setup.ts
  </files>
  <action>
1. Create a public callback route (outside `/api/*` bearer middleware) that handles GitHub redirect parameters (`code`, `state`).
2. Validate callback safety:
   - state exists, unexpired, unused;
   - state is consumed atomically to prevent replay.
3. Exchange code via `POST https://github.com/login/oauth/access_token` with `Accept: application/json`.
4. Revalidate identity using `GET https://api.github.com/user` with `Authorization: Bearer`.
5. Store token with existing credential security model:
   - Write token to encrypted `credentials` entry (`service='github'`, `key='oauth_token'`).
   - Rotate/deactivate prior active GitHub token credential for identity consistency.
6. Upsert setup-state identity fields (`githubConnected`, user id/login, token credential reference), clear transient OAuth state, then redirect back to dashboard.
7. Ensure route errors never include plaintext tokens.
  </action>
  <verify>
    - Invalid or expired `state` returns deterministic failure (400/403) without leaking secrets.
    - Valid callback path updates `setup_state` and creates/rotates `credentials` entry.
    - `pnpm build --filter @jarvis/dashboard` succeeds.
  </verify>
  <done>OAuth callback completes only with validated one-time state, persists verified identity, and stores access token encrypted with no plaintext exposure.</done>
</task>

<task type="auto">
  <name>Task 3: Remove stub behavior and align setup state API with real OAuth status</name>
  <files>
    apps/dashboard/src/routes/setup.ts
  </files>
  <action>
1. Remove placeholder implementation that sets `githubUsername='pending-oauth'`.
2. Ensure `GET /api/setup` reflects real status fields from DB (connected identity metadata, repo-bound fields when present).
3. Keep response backward-compatible for existing UI fields while adding optional fields needed by Phase 10 frontend updates.
  </action>
  <verify>
    - `rg -n \"pending-oauth|stub\" apps/dashboard/src/routes/setup.ts` returns no active stub logic.
    - `GET /api/setup` returns truthful OAuth-derived state.
  </verify>
  <done>Setup API no longer relies on placeholder GitHub connection logic and now reports real OAuth-backed identity status.</done>
</task>

</tasks>

<verification>
- `pnpm build --filter @jarvis/dashboard`
- OAuth start URL generation works and includes PKCE/state parameters
- Callback rejects replay/expired state and persists validated identity on success
</verification>

<success_criteria>
The dashboard backend performs real GitHub OAuth code exchange with anti-forgery protections and encrypted token persistence, fully replacing placeholder identity connection behavior.
</success_criteria>

<output>
After completion, create `.planning/phases/10-github-identity-and-repo-trust/10-02-SUMMARY.md`
</output>
