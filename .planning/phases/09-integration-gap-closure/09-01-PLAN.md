---
phase: 09-integration-gap-closure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/agent/src/index.ts
  - apps/agent/src/shutdown.ts
  - apps/agent/src/multi-agent/agent-worker.ts
autonomous: true
requirements:
  - COST-02
  - MULTI-02

must_haves:
  truths:
    - "CreditMonitor is instantiated at agent startup and polls OpenRouter credit balance every 5 minutes"
    - "CreditMonitor sends Discord DM when credits fall below $5 threshold (if Discord env vars are set)"
    - "CreditMonitor is stopped cleanly during graceful shutdown (clearInterval prevents event loop hang)"
    - "Sub-agent worker LLM prompts include all 30+ registered tools, not just Phase 1+3 tools"
    - "After tool_write creates a new tool at runtime, the next sub-agent spawn sees it in its LLM prompt"
  artifacts:
    - path: "apps/agent/src/index.ts"
      provides: "CreditMonitor wiring + reordered Supervisor/agentWorker after all tool registrations"
      contains: "new CreditMonitor"
    - path: "apps/agent/src/shutdown.ts"
      provides: "CreditMonitor shutdown integration"
      contains: "creditMonitor"
    - path: "apps/agent/src/multi-agent/agent-worker.ts"
      provides: "Lazy per-job tool derivation from registry"
      contains: "toolDefinitionsToOpenAI(registry)"
  key_links:
    - from: "apps/agent/src/index.ts"
      to: "CreditMonitor class in @jarvis/ai"
      via: "import { CreditMonitor } from '@jarvis/ai'"
      pattern: "new CreditMonitor"
    - from: "apps/agent/src/index.ts"
      to: "apps/agent/src/shutdown.ts"
      via: "creditMonitor field in registerShutdownHandlers"
      pattern: "creditMonitor"
    - from: "apps/agent/src/multi-agent/agent-worker.ts"
      to: "toolDefinitionsToOpenAI in @jarvis/ai"
      via: "import and per-job call inside Worker handler"
      pattern: "toolDefinitionsToOpenAI\\(registry\\)"
---

<objective>
Wire CreditMonitor into agent startup/shutdown and fix sub-agent worker stale tool snapshot.

Purpose: Close the two integration wiring gaps identified by the v1 milestone audit: (1) CreditMonitor was implemented in Phase 2 but never instantiated — OpenRouter credit balance is never polled and low-credit Discord DMs never fire; (2) createAgentWorker receives a stale `openAITools` snapshot captured before Phase 4/6/8 tool registrations, so sub-agent LLM prompts only see 7 tools instead of 30+.

Output: Three modified files — agent startup/shutdown with CreditMonitor lifecycle, agent-worker with lazy tool derivation per job.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-integration-gap-closure/09-RESEARCH.md
@apps/agent/src/index.ts
@apps/agent/src/shutdown.ts
@apps/agent/src/multi-agent/agent-worker.ts
@packages/ai/src/cost-monitor.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire CreditMonitor into agent startup and shutdown</name>
  <files>apps/agent/src/index.ts, apps/agent/src/shutdown.ts</files>
  <action>
**In `apps/agent/src/index.ts`:**

1. Add `CreditMonitor` to the existing `@jarvis/ai` import on line 6:
   ```typescript
   import { createRouter, KillSwitchGuard, loadModelConfig, toolDefinitionsToOpenAI, CreditMonitor } from '@jarvis/ai';
   ```

2. After the router creation (line 70, `const router = createRouter(...)`) and before the model config log (line 73), insert CreditMonitor instantiation and start:
   ```typescript
   // Phase 9: CreditMonitor — polls OpenRouter balance, Discord DM on low credits
   const creditMonitor = new CreditMonitor(
     {
       apiKey: process.env.OPENROUTER_API_KEY!,
       discordBotToken: process.env.DISCORD_BOT_TOKEN,
       discordOperatorUserId: process.env.DISCORD_OPERATOR_USER_ID,
     },
     db,
   );
   creditMonitor.start();
   process.stderr.write('[agent] CreditMonitor started (polling every 5 minutes).\n');
   ```

3. Add `creditMonitor` to the `registerShutdownHandlers` call (currently at ~line 339). Add it as a new field alongside the existing resources:
   ```typescript
   registerShutdownHandlers({
     pool,
     redis,
     consolidation,
     supervisor,
     agentWorker,
     agentTasksQueue,
     signerProcess,
     walletSubscription,
     browserManager: browserManager as ShutdownBrowserManager,
     reloadToolsQueue,
     creditMonitor,
   });
   ```

**In `apps/agent/src/shutdown.ts`:**

1. Add `creditMonitor` field to the `ShutdownResources` interface (after `reloadToolsQueue`, before the closing `}`):
   ```typescript
   /** Phase 9: CreditMonitor (OpenRouter balance polling interval) */
   creditMonitor?: { stop(): void };
   ```

2. Add `creditMonitor` to the destructuring in `registerShutdownHandlers` (add after `reloadToolsQueue`):
   ```typescript
   const { pool, redis, worker, consolidation, supervisor, agentWorker, agentTasksQueue, signerProcess, walletSubscription, browserManager, reloadToolsQueue, creditMonitor } = resources;
   ```

3. In `gracefulShutdown()`, add CreditMonitor stop immediately after the consolidation interval stop (after the `clearInterval(consolidation)` block, before wallet subscription stop):
   ```typescript
   // 1.5. Stop CreditMonitor polling interval (Phase 9 — prevents event loop hang)
   if (creditMonitor !== undefined) {
     creditMonitor.stop();
     process.stderr.write('[shutdown] CreditMonitor stopped.\n');
   }
   ```
  </action>
  <verify>Run `pnpm build` from the monorepo root to confirm TypeScript compiles without errors. Verify CreditMonitor import resolves and shutdown type-checks.</verify>
  <done>CreditMonitor is imported from @jarvis/ai, instantiated with env vars after router creation, started immediately, and stopped during graceful shutdown. The `[agent] CreditMonitor started` log line appears in the startup sequence.</done>
</task>

<task type="auto">
  <name>Task 2: Fix sub-agent worker stale tool snapshot with lazy derivation</name>
  <files>apps/agent/src/multi-agent/agent-worker.ts, apps/agent/src/index.ts</files>
  <action>
**In `apps/agent/src/multi-agent/agent-worker.ts`:**

1. Add `toolDefinitionsToOpenAI` import from `@jarvis/ai`:
   ```typescript
   import { toolDefinitionsToOpenAI } from '@jarvis/ai';
   ```

2. Remove the `ChatCompletionTool` type alias (line 13, `type ChatCompletionTool = ...`). It is no longer needed since tools are derived internally, not passed as a parameter.

3. In the `createAgentWorker` deps parameter type, remove the `tools: ChatCompletionTool[];` line. The updated deps type should be:
   ```typescript
   export function createAgentWorker(deps: {
     redisUrl: string;
     router: ModelRouter;
     registry: ToolRegistry;
     killSwitch: KillCheckable;
     db: DbClient;
     concurrency?: number;
   }): Worker {
   ```

4. Update the destructuring on the next line to remove `tools`:
   ```typescript
   const { redisUrl, router, registry, killSwitch, db, concurrency = 3 } = deps;
   ```

5. Inside the Worker job handler (the `async (job) => {` callback), add lazy tool derivation as the first line of the handler, before the `const { task, context }` destructuring:
   ```typescript
   // MULTI-02: Derive fresh tool snapshot from registry at job start.
   // Captures all tools registered at startup (Phase 1-8) plus any
   // tools added by tool_write at runtime since last job.
   const tools = toolDefinitionsToOpenAI(registry);
   ```
   The existing `router.completeWithTools(messages, 'mid', tools)` call on line 84 will now use this locally-scoped `tools` variable instead of the removed parameter.

**In `apps/agent/src/index.ts`:**

1. **Move Supervisor construction and createAgentWorker call** from their current positions (lines ~135-155, before Phase 4) to after the final `openAITools = toolDefinitionsToOpenAI(registry)` re-derivation at line 330 (end of Phase 8 block).

   Specifically, cut the following blocks from their current locations:
   - The Supervisor construction (lines 135-145): `const supervisor = new Supervisor(...)`
   - The createAgentWorker call (lines 147-155): `const agentWorker = createAgentWorker(...)`

   And paste them after the Phase 8 ready log (line ~336), BEFORE the `registerShutdownHandlers` call:
   ```typescript
   // === Phase 9: Supervisor + Worker positioned after all tool registrations ===

   // Supervisor manages multiple independent main agent loops (one per active goal).
   // Constructed here (after Phase 4/6/8 tool registrations) so openAITools includes
   // all 30+ tools, not just the Phase 1+3 snapshot.
   const supervisor = new Supervisor(
     db,
     router,
     registry,
     killSwitch,
     goalManager,
     evaluator,
     replanner,
     openAITools,
     strategyManager,
   );

   // Create agent-tasks worker (processes sub-agent BullMQ jobs).
   // tools param removed — worker derives fresh tools from registry per job,
   // so tool_write additions are visible to the next sub-agent spawn.
   const agentWorker = createAgentWorker({
     redisUrl: process.env.REDIS_URL!,
     router,
     registry,
     killSwitch,
     db,
   });
   ```

   Note: `tools: openAITools` is removed from the createAgentWorker call since the worker now derives tools lazily from the registry.

2. The variables `supervisor` and `agentWorker` are used later in the file by `registerShutdownHandlers`, startup recovery, and `supervisor.startSupervisorLoop()`. Ensure they remain declared with `const` before those usages (they will be, since we're placing them before `registerShutdownHandlers`).

3. Update the `StrategyManager wired into Supervisor` log line (currently at line 132) to stay in its current position since it describes StrategyManager creation, not Supervisor creation. The Supervisor construction moves down but the StrategyManager creation stays where it is.
  </action>
  <verify>Run `pnpm build` from the monorepo root — zero TypeScript errors. Verify that `agent-worker.ts` no longer has a `tools` parameter and instead calls `toolDefinitionsToOpenAI(registry)` inside the job handler. Verify that `index.ts` constructs Supervisor and agentWorker AFTER the Phase 8 `openAITools` re-derivation.</verify>
  <done>agent-worker.ts derives a fresh tool snapshot from the registry at the start of each sub-agent job (lazy derivation). The createAgentWorker call site in index.ts no longer passes `tools: openAITools`. Both Supervisor and agentWorker are constructed after all Phase 4/6/8 tool registrations complete, so the Supervisor's stored tools array includes all 30+ tools at startup. Runtime tool_write additions are visible to sub-agent workers on their next spawn via lazy registry derivation.</done>
</task>

</tasks>

<verification>
1. `pnpm build` succeeds with zero TypeScript errors across all packages
2. In `apps/agent/src/index.ts`:
   - `CreditMonitor` is imported from `@jarvis/ai`
   - `new CreditMonitor(...)` appears after `createRouter(...)` and before Phase 3 block
   - `creditMonitor.start()` is called immediately after construction
   - `creditMonitor` is passed to `registerShutdownHandlers`
   - `const supervisor = new Supervisor(...)` appears AFTER the Phase 8 `openAITools` re-derivation
   - `const agentWorker = createAgentWorker(...)` appears after Supervisor construction and does NOT include `tools:` in its options
3. In `apps/agent/src/shutdown.ts`:
   - `ShutdownResources.creditMonitor` field exists with type `{ stop(): void }`
   - `creditMonitor.stop()` is called in `gracefulShutdown()` before wallet subscription stop
4. In `apps/agent/src/multi-agent/agent-worker.ts`:
   - `toolDefinitionsToOpenAI` is imported from `@jarvis/ai`
   - `createAgentWorker` deps type does NOT have a `tools` parameter
   - `const tools = toolDefinitionsToOpenAI(registry)` appears inside the Worker job handler (per-job, not per-worker)
</verification>

<success_criteria>
- CreditMonitor polls OpenRouter balance every 5 minutes starting at agent boot
- CreditMonitor sends Discord DM on low credits (when Discord env vars configured)
- CreditMonitor.stop() fires during graceful shutdown (no event loop hang)
- Sub-agent worker LLM prompts contain all 30+ registered tools (Phase 1-8 + persisted)
- Tools added by tool_write at runtime appear in the next sub-agent spawn's LLM prompt
- pnpm build passes with zero TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/09-integration-gap-closure/09-01-SUMMARY.md`
</output>
