---
phase: 11-version-controlled-self-modification-pipeline
plan: 02
type: execute
wave: 2
depends_on:
  - 11-01
files_modified:
  - packages/tools/src/self-extension/github-trust-guard.ts
  - packages/tools/src/self-extension/github-pipeline.ts
  - packages/tools/src/self-extension/staging-deployer.ts
  - packages/tools/src/self-extension/tool-writer.ts
  - packages/tools/src/self-extension/index.ts
autonomous: true
requirements:
  - SEXT-05
  - SEXT-06
  - SEXT-07
must_haves:
  truths:
    - "Core builtin modifications create or reuse a deterministic branch in the bound GitHub repository from default-branch HEAD."
    - "Each proposed change creates a repository commit with machine-readable goal/cycle/tool metadata."
    - "A pull request is created or updated for the branch and includes sandbox evidence with explicit status context updates."
  artifacts:
    - path: "packages/tools/src/self-extension/github-pipeline.ts"
      provides: "GitHub branch/commit/PR orchestration for builtin self-modification attempts"
      exports: ["runGitHubSelfExtensionPipeline"]
    - path: "packages/tools/src/self-extension/staging-deployer.ts"
      provides: "Delegation wrapper from legacy stageBuiltinChange path to GitHub pipeline implementation"
      pattern: "runGitHubSelfExtensionPipeline"
    - path: "packages/tools/src/self-extension/tool-writer.ts"
      provides: "Builtin modify path returns PR-backed result payload instead of local-only fast-forward merge semantics"
      pattern: "pullRequestUrl"
  key_links:
    - from: "packages/tools/src/self-extension/tool-writer.ts"
      to: "packages/tools/src/self-extension/staging-deployer.ts"
      via: "builtinModify execution path invokes repository pipeline"
      pattern: "stageBuiltinChange"
    - from: "packages/tools/src/self-extension/staging-deployer.ts"
      to: "packages/tools/src/self-extension/github-pipeline.ts"
      via: "legacy staging adapter delegates to GitHub branch/commit/PR orchestrator"
      pattern: "runGitHubSelfExtensionPipeline"
    - from: "packages/tools/src/self-extension/github-pipeline.ts"
      to: "packages/tools/src/self-extension/github-trust-guard.ts"
      via: "load trusted repo binding and decrypted oauth token before GitHub API calls"
      pattern: "githubRepoFullName"
---

<objective>
Implement the repository-backed branch/commit/PR pipeline for builtin self-modification.

Purpose: Replace local-only staging behavior with an auditable GitHub flow that satisfies branch and traceability requirements.
Output: A GitHub pipeline module wired into `tool_write` that creates deterministic branches, commits metadata-rich changes, and upserts PRs with sandbox evidence.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/11-version-controlled-self-modification-pipeline/11-RESEARCH.md
@.planning/phases/11-version-controlled-self-modification-pipeline/11-01-PLAN.md
@packages/tools/src/self-extension/pipeline-context.ts
@packages/tools/src/self-extension/branch-naming.ts
@packages/tools/src/self-extension/github-trust-guard.ts
@packages/tools/src/self-extension/staging-deployer.ts
@packages/tools/src/self-extension/tool-writer.ts
@apps/dashboard/src/routes/github-oauth-helpers.ts
@apps/dashboard/src/routes/setup.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add trusted GitHub pipeline orchestration module for branch and commit creation</name>
  <files>
    packages/tools/src/self-extension/github-trust-guard.ts
    packages/tools/src/self-extension/github-pipeline.ts
    packages/tools/src/self-extension/index.ts
  </files>
  <action>
1. Extend trust helper(s) to expose a reusable trusted GitHub context for pipeline calls:
   - bound repo full name + default branch + token credential validation;
   - decrypted OAuth token retrieval with fail-closed errors.
2. Implement `github-pipeline.ts` core flow:
   - resolve default branch base SHA from bound repo;
   - create deterministic branch (or reuse existing branch for same identity);
   - create/update target file content in that branch with commit metadata in message body/trailers.
3. Keep commit metadata generation tied to Plan 11-01 helper output so SEXT-06 fields are always present.
4. Export pipeline entrypoint through `self-extension/index.ts`.
  </action>
  <verify>
    - `pnpm build --filter @jarvis/tools` succeeds.
    - `rg -n "runGitHubSelfExtensionPipeline|Jarvis-Meta|refs/heads" packages/tools/src/self-extension` returns expected orchestration points.
  </verify>
  <done>Self-extension tooling can create deterministic branch commits in the trusted GitHub repository using validated setup trust context.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate repository pipeline into staging-deployer and tool_write builtin path</name>
  <files>
    packages/tools/src/self-extension/staging-deployer.ts
    packages/tools/src/self-extension/tool-writer.ts
  </files>
  <action>
1. Refactor `stageBuiltinChange` so it delegates to GitHub pipeline orchestration rather than local branch checkout/fast-forward merge.
2. Preserve existing safety ordering:
   - run compile and sandbox validation before promotion operations;
   - return fail-closed result when compile/sandbox fails.
3. Update builtin `tool_write` success payload to include repository flow outputs:
   - branch name,
   - head commit sha,
   - pull request URL/number,
   - evidence status context.
4. Keep non-builtin tool-write path unchanged.
  </action>
  <verify>
    - `pnpm build --filter @jarvis/tools` succeeds.
    - `rg -n "pullRequestUrl|headSha|builtin-pr" packages/tools/src/self-extension/tool-writer.ts` returns new response fields.
  </verify>
  <done>Builtin modifications route through GitHub repository branch+commit flow and return PR-oriented result data for traceability.</done>
</task>

<task type="auto">
  <name>Task 3: Implement PR upsert and sandbox evidence/status publication</name>
  <files>
    packages/tools/src/self-extension/github-pipeline.ts
    packages/tools/src/self-extension/staging-deployer.ts
    packages/tools/src/self-extension/tool-writer.ts
  </files>
  <action>
1. Add PR upsert behavior keyed by deterministic branch head:
   - list open PRs for branch,
   - create PR if missing,
   - update existing PR title/body if present.
2. Publish sandbox evidence in a structured, redactable format:
   - include pass/fail state, duration, tool/file metadata, short diagnostic summary;
   - avoid raw secret leakage in comments/body.
3. Set commit status context (for example `jarvis/sandbox`) on candidate SHA to reflect evidence outcome.
4. Ensure failure path still produces a PR/evidence trail when code was committed, and returns deterministic errors when commit creation is blocked.
  </action>
  <verify>
    - `pnpm build --filter @jarvis/tools` succeeds.
    - `rg -n "jarvis/sandbox|create a pull request|update a pull request|statuses" packages/tools/src/self-extension/github-pipeline.ts` confirms PR/evidence wiring.
  </verify>
  <done>Each candidate self-modification has a single auditable PR with attached sandbox evidence and explicit status context on the candidate commit.</done>
</task>

</tasks>

<verification>
- `pnpm build --filter @jarvis/tools`
- Validate builtinModify result payload includes branch, sha, and PR URL
- Manual smoke: invoke builtinModify against a safe test file in a sandbox repo and confirm PR/evidence creation
</verification>

<success_criteria>
Core self-modification attempts now run through deterministic repository branch+commit+PR flow with machine-readable metadata and sandbox evidence status.
</success_criteria>

<output>
After completion, create `.planning/phases/11-version-controlled-self-modification-pipeline/11-02-SUMMARY.md`
</output>
