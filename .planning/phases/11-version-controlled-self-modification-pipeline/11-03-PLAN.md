---
phase: 11-version-controlled-self-modification-pipeline
plan: 03
type: execute
wave: 3
depends_on:
  - 11-02
files_modified:
  - packages/tools/src/self-extension/promotion-gate.ts
  - packages/tools/src/self-extension/github-pipeline.ts
  - packages/tools/src/self-extension/staging-deployer.ts
  - packages/tools/src/self-extension/tool-writer.ts
  - packages/tools/src/self-extension/index.ts
  - README.md
autonomous: true
requirements:
  - SEXT-08
must_haves:
  truths:
    - "Promotion/merge is blocked when required sandbox or regression contexts are pending, failing, or missing."
    - "Successful promotion merges only the expected head commit and cleans up short-lived branch artifacts."
    - "Failure states return operator-readable reasons and leave PR context intact for diagnosis."
  artifacts:
    - path: "packages/tools/src/self-extension/promotion-gate.ts"
      provides: "Reusable merge-gate evaluator for required status contexts"
      exports: ["evaluatePromotionGate"]
    - path: "packages/tools/src/self-extension/github-pipeline.ts"
      provides: "Promotion/merge path that checks statuses then merges with head-sha guard"
      pattern: "merge a pull request"
    - path: "README.md"
      provides: "Updated self-extension behavior docs for PR-backed promotion and merge blocking semantics"
      pattern: "tool_write"
  key_links:
    - from: "packages/tools/src/self-extension/github-pipeline.ts"
      to: "packages/tools/src/self-extension/promotion-gate.ts"
      via: "pre-merge gate evaluation on candidate commit SHA"
      pattern: "evaluatePromotionGate"
    - from: "packages/tools/src/self-extension/staging-deployer.ts"
      to: "packages/tools/src/self-extension/github-pipeline.ts"
      via: "promotion call respects gate result before merge attempt"
      pattern: "promote"
    - from: "packages/tools/src/self-extension/tool-writer.ts"
      to: "packages/tools/src/self-extension/staging-deployer.ts"
      via: "builtin modify response includes promotion outcome and block reason when checks fail"
      pattern: "promotionBlocked"
---

<objective>
Enforce merge-time promotion guardrails for repository-backed self-modification.

Purpose: SEXT-08 requires failed or missing checks to block promotion; merge must be explicit, deterministic, and fail closed.
Output: Promotion-gate module, merge-path integration, and documentation updates describing blocked vs successful promotion behavior.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/11-version-controlled-self-modification-pipeline/11-RESEARCH.md
@.planning/phases/11-version-controlled-self-modification-pipeline/11-02-PLAN.md
@packages/tools/src/self-extension/github-pipeline.ts
@packages/tools/src/self-extension/staging-deployer.ts
@packages/tools/src/self-extension/tool-writer.ts
@README.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement reusable promotion gate evaluator for required status contexts</name>
  <files>
    packages/tools/src/self-extension/promotion-gate.ts
    packages/tools/src/self-extension/index.ts
  </files>
  <action>
1. Add `promotion-gate.ts` module that evaluates whether a commit SHA is merge-eligible based on required context states.
2. Define default required contexts for Phase 11 (at minimum `jarvis/sandbox`) and support extension for future regression contexts from Phase 12.
3. Return structured outcomes:
   - `ready` when all required contexts are `success`,
   - `blocked` with explicit failing/pending/missing context reasons.
4. Export the gate evaluator via self-extension index for use in pipeline orchestration and future verification tooling.
  </action>
  <verify>
    - `pnpm build --filter @jarvis/tools` succeeds.
    - `rg -n "evaluatePromotionGate|jarvis/sandbox|blocked" packages/tools/src/self-extension/promotion-gate.ts` returns gate logic and reason mapping.
  </verify>
  <done>Promotion eligibility can be evaluated deterministically from commit status contexts with clear block reasons.</done>
</task>

<task type="auto">
  <name>Task 2: Enforce gate checks in merge path with head-sha safety and branch cleanup</name>
  <files>
    packages/tools/src/self-extension/github-pipeline.ts
    packages/tools/src/self-extension/staging-deployer.ts
    packages/tools/src/self-extension/tool-writer.ts
  </files>
  <action>
1. Update GitHub pipeline promotion path to:
   - fetch combined statuses for candidate SHA,
   - evaluate via `evaluatePromotionGate`,
   - block merge when gate is not ready.
2. When gate passes, merge PR using explicit head SHA guard to avoid stale-head merges.
3. After successful merge, delete short-lived branch and return promotion success details.
4. On blocked/failed merge, keep PR and branch intact, and return deterministic result payload (`promotionBlocked`, `blockReasons`, `mergeError`).
5. Ensure `tool_write` builtin responses expose promotion state for operator/agent reasoning.
  </action>
  <verify>
    - `pnpm build --filter @jarvis/tools` succeeds.
    - `rg -n "promotionBlocked|blockReasons|merge" packages/tools/src/self-extension/tool-writer.ts packages/tools/src/self-extension/github-pipeline.ts` shows merge gate response wiring.
  </verify>
  <done>Promotion now fails closed unless required checks are green, and successful merges are SHA-guarded with cleanup of temporary branch artifacts.</done>
</task>

<task type="auto">
  <name>Task 3: Update documentation and operator expectations for PR-backed promotion flow</name>
  <files>
    README.md
  </files>
  <action>
1. Update self-extension/tooling sections to describe current builtin modify lifecycle:
   - deterministic branch creation,
   - commit metadata,
   - PR/evidence update,
   - merge blocked on failed/pending checks.
2. Clarify that builtin modifications now return PR-backed outcomes instead of local fast-forward merge semantics.
3. Add concise troubleshooting notes for common blocked states (missing status context, failed sandbox evidence, stale head).
  </action>
  <verify>
    - `rg -n "PR|promotion|blocked|tool_write" README.md` confirms updated behavior documentation.
  </verify>
  <done>Repo docs reflect the enforced promotion gate and provide practical guidance for blocked and successful self-modification promotions.</done>
</task>

</tasks>

<verification>
- `pnpm build --filter @jarvis/tools`
- Manual gate smoke: confirm merge is blocked when `jarvis/sandbox` status is not success
- Manual success smoke: confirm merge succeeds with expected head SHA and branch cleanup after gate pass
</verification>

<success_criteria>
Promotion path now enforces status-based merge gating, blocks failed checks, and merges safely only when required contexts are green.
</success_criteria>

<output>
After completion, create `.planning/phases/11-version-controlled-self-modification-pipeline/11-03-SUMMARY.md`
</output>
