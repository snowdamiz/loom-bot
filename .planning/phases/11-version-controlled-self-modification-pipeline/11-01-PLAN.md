---
phase: 11-version-controlled-self-modification-pipeline
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/agent/src/loop/agent-loop.ts
  - apps/agent/src/multi-agent/agent-worker.ts
  - packages/tools/src/invoke-safe.ts
  - packages/tools/src/invoke.ts
  - packages/tools/src/self-extension/pipeline-context.ts
  - packages/tools/src/self-extension/branch-naming.ts
  - packages/tools/src/self-extension/index.ts
autonomous: true
requirements:
  - SEXT-05
  - SEXT-06
must_haves:
  truths:
    - "Builtin self-modification receives deterministic execution context (goal, cycle, sub-goal, tool identity) without breaking non-self-extension tool calls."
    - "Deterministic short-lived branch naming is generated from execution context plus change fingerprint rather than timestamps."
    - "Machine-readable commit metadata payload can be generated in one shared format for downstream GitHub commit/PR steps."
  artifacts:
    - path: "packages/tools/src/self-extension/pipeline-context.ts"
      provides: "Execution context and commit metadata envelope types/builders for self-extension pipeline"
      exports: ["SelfExtensionExecutionContext", "buildCommitMetadata"]
    - path: "packages/tools/src/self-extension/branch-naming.ts"
      provides: "Deterministic branch name generator for core self-modification attempts"
      exports: ["buildSelfExtensionBranchName"]
    - path: "packages/tools/src/invoke.ts"
      provides: "Tool invocation path with optional internal execution context plumbing"
      pattern: "executionContext"
  key_links:
    - from: "apps/agent/src/loop/agent-loop.ts"
      to: "packages/tools/src/invoke-safe.ts"
      via: "pass goal/cycle/sub-goal execution context on each invokeWithKillCheck call"
      pattern: "executionContext"
    - from: "packages/tools/src/invoke-safe.ts"
      to: "packages/tools/src/invoke.ts"
      via: "optional execution context passthrough to logging/invocation layer"
      pattern: "invokeWithLogging"
    - from: "packages/tools/src/self-extension/branch-naming.ts"
      to: "packages/tools/src/self-extension/index.ts"
      via: "export deterministic naming helper for staging/pipeline integration"
      pattern: "buildSelfExtensionBranchName"
---

<objective>
Create the execution-context and deterministic identity foundation for GitHub-backed self-modification.

Purpose: SEXT-05 and SEXT-06 require deterministic branch and metadata identity per change; current invoke path does not carry enough context to do this correctly.
Output: Invocation context plumbing plus reusable helpers for deterministic branch naming and commit metadata generation.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/11-version-controlled-self-modification-pipeline/11-RESEARCH.md
@apps/agent/src/loop/agent-loop.ts
@apps/agent/src/multi-agent/agent-worker.ts
@packages/tools/src/invoke-safe.ts
@packages/tools/src/invoke.ts
@packages/tools/src/self-extension/tool-writer.ts
@packages/tools/src/self-extension/staging-deployer.ts
@packages/tools/src/self-extension/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add self-extension execution-context and commit-metadata helpers</name>
  <files>
    packages/tools/src/self-extension/pipeline-context.ts
    packages/tools/src/self-extension/branch-naming.ts
    packages/tools/src/self-extension/index.ts
  </files>
  <action>
1. Create `pipeline-context.ts` with strongly typed context primitives for core self-modification calls:
   - required metadata: `goalId`, `cycleId`, `subGoalId`, `toolName`;
   - optional trace details (for example tool call id or actor source).
2. Add a helper that builds a machine-readable commit metadata payload object/string from execution context (stable key order, deterministic serialization).
3. Create `branch-naming.ts` helper that generates deterministic short-lived branch names from context + change fingerprint (`toolName`, `filePath`, content hash) and enforces safe branch-token normalization.
4. Export the new helpers through `packages/tools/src/self-extension/index.ts` for use in later plans.
  </action>
  <verify>
    - `pnpm build --filter @jarvis/tools` succeeds.
    - `rg -n "SelfExtensionExecutionContext|buildCommitMetadata|buildSelfExtensionBranchName" packages/tools/src/self-extension` returns expected definitions.
  </verify>
  <done>Self-extension has reusable deterministic branch and metadata helper modules ready for GitHub pipeline integration.</done>
</task>

<task type="auto">
  <name>Task 2: Thread optional execution context through tool invocation functions</name>
  <files>
    packages/tools/src/invoke-safe.ts
    packages/tools/src/invoke.ts
  </files>
  <action>
1. Extend `invokeWithKillCheck` and `invokeWithLogging` signatures to accept an optional internal `executionContext` argument.
2. Keep full backward compatibility: existing call sites that omit this argument must continue working unchanged.
3. Ensure the new argument is passed through invocation layers without changing tool schema validation behavior for regular tool inputs.
4. Add concise inline comments where needed to clarify that execution context is internal metadata, not LLM-facing input schema.
  </action>
  <verify>
    - `pnpm build --filter @jarvis/tools` succeeds.
    - Existing call sites compile without mandatory signature changes.
    - `rg -n "executionContext" packages/tools/src/invoke-safe.ts packages/tools/src/invoke.ts` returns plumbing points.
  </verify>
  <done>Invocation layer can carry execution metadata for self-extension without regressing non-self-extension tool execution.</done>
</task>

<task type="auto">
  <name>Task 3: Populate execution context from agent loops and worker paths</name>
  <files>
    apps/agent/src/loop/agent-loop.ts
    apps/agent/src/multi-agent/agent-worker.ts
  </files>
  <action>
1. In `AgentLoop.runGoalCycle`, thread `cycleLogId` into `executeSubGoal` so each tool call can include cycle-level context.
2. In `executeSubGoal`, pass execution context to `invokeWithKillCheck` for every tool call:
   - `goalId` from sub-goal;
   - `cycleId` from `logCycleStart` row id;
   - `subGoalId` from current sub-goal;
   - `toolName` from tool call.
3. In sub-agent worker path, pass best-effort context (for example task/job identifiers) while keeping fields nullable where not available.
4. Preserve existing control flow and kill-switch behavior; this task is metadata propagation only.
  </action>
  <verify>
    - `pnpm build --filter @jarvis/agent` succeeds.
    - `rg -n "cycleLogId|executionContext" apps/agent/src/loop/agent-loop.ts apps/agent/src/multi-agent/agent-worker.ts` shows context propagation.
  </verify>
  <done>Agent execution paths now provide deterministic per-call context required for SEXT-06 commit traceability.</done>
</task>

</tasks>

<verification>
- `pnpm build --filter @jarvis/tools`
- `pnpm build --filter @jarvis/agent`
- Confirm new context and branch helpers are exported from self-extension index
</verification>

<success_criteria>
Execution metadata and deterministic branch identity primitives exist and are wired from live agent tool invocations, enabling downstream branch/commit/PR implementation work.
</success_criteria>

<output>
After completion, create `.planning/phases/11-version-controlled-self-modification-pipeline/11-01-SUMMARY.md`
</output>
