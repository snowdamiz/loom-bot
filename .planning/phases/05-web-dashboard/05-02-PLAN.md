---
phase: 05-web-dashboard
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - apps/dashboard/client/package.json
  - apps/dashboard/client/tsconfig.json
  - apps/dashboard/client/vite.config.ts
  - apps/dashboard/client/index.html
  - apps/dashboard/client/src/main.tsx
  - apps/dashboard/client/src/App.tsx
  - apps/dashboard/client/src/App.css
  - apps/dashboard/client/src/lib/api.ts
  - apps/dashboard/client/src/hooks/useSSE.ts
  - apps/dashboard/client/src/hooks/useAgentData.ts
  - apps/dashboard/client/src/components/AuthGate.tsx
  - apps/dashboard/client/src/components/OverviewTab.tsx
  - apps/dashboard/client/src/components/KillSwitchButton.tsx
autonomous: true
requirements:
  - DASH-01
  - DASH-05
  - DASH-06

must_haves:
  truths:
    - "Operator can enter a token/password and gain access to the dashboard"
    - "Invalid token shows an error message and does not grant access"
    - "Overview tab displays agent status (alive/halted, current goal, uptime, last action)"
    - "Kill switch button activates/deactivates with confirmation dialog"
    - "Status updates arrive via SSE without manual refresh"
  artifacts:
    - path: "apps/dashboard/client/package.json"
      provides: "React SPA package definition"
      contains: "@jarvis/dashboard-client"
    - path: "apps/dashboard/client/src/App.tsx"
      provides: "Tab container with overview and activity tabs"
      min_lines: 30
    - path: "apps/dashboard/client/src/components/AuthGate.tsx"
      provides: "Token auth gate component"
      min_lines: 20
    - path: "apps/dashboard/client/src/components/OverviewTab.tsx"
      provides: "Agent status display with compact cards"
      min_lines: 40
    - path: "apps/dashboard/client/src/components/KillSwitchButton.tsx"
      provides: "Kill switch with confirmation dialog"
      min_lines: 30
    - path: "apps/dashboard/client/src/hooks/useSSE.ts"
      provides: "SSE connection hook with auth header"
      min_lines: 20
  key_links:
    - from: "apps/dashboard/client/src/hooks/useSSE.ts"
      to: "/api/sse"
      via: "fetchEventSource with Authorization header"
      pattern: "fetchEventSource.*api/sse"
    - from: "apps/dashboard/client/src/hooks/useAgentData.ts"
      to: "/api/status"
      via: "TanStack Query fetch"
      pattern: "api/status"
    - from: "apps/dashboard/client/src/components/KillSwitchButton.tsx"
      to: "/api/kill-switch"
      via: "POST fetch"
      pattern: "api/kill-switch"
    - from: "apps/dashboard/client/src/components/AuthGate.tsx"
      to: "/api/status"
      via: "token validation fetch"
      pattern: "api/status"
---

<objective>
Create the React/Vite SPA with auth gate, Overview tab, kill switch button, and SSE real-time updates.

Purpose: This gives the operator their primary view into the agent -- can I see what it's doing, and can I stop it? The Overview tab is the default landing with compact status cards, and the kill switch provides emergency control.

Output: `apps/dashboard/client` React SPA with authentication, real-time status display, and kill switch control.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-web-dashboard/05-RESEARCH.md
@.planning/phases/05-web-dashboard/05-01-SUMMARY.md

@apps/dashboard/src/app.ts
@apps/dashboard/src/routes/status.ts
@apps/dashboard/src/routes/kill-switch.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: React/Vite SPA scaffold + auth gate + hooks</name>
  <files>
    apps/dashboard/client/package.json
    apps/dashboard/client/tsconfig.json
    apps/dashboard/client/vite.config.ts
    apps/dashboard/client/index.html
    apps/dashboard/client/src/main.tsx
    apps/dashboard/client/src/App.tsx
    apps/dashboard/client/src/App.css
    apps/dashboard/client/src/lib/api.ts
    apps/dashboard/client/src/hooks/useSSE.ts
    apps/dashboard/client/src/hooks/useAgentData.ts
    apps/dashboard/client/src/components/AuthGate.tsx
  </files>
  <action>
    **Client package scaffold:**
    - Create `apps/dashboard/client/package.json`:
      - name: `@jarvis/dashboard-client`
      - private: true
      - type: `module`
      - scripts: `dev` (vite), `build` (tsc -b && vite build), `preview` (vite preview)
      - dependencies: `react`, `react-dom`, `@tanstack/react-query`, `@microsoft/fetch-event-source`
      - devDependencies: `vite`, `@vitejs/plugin-react`, `typescript`, `@types/react`, `@types/react-dom`
    - Create `apps/dashboard/client/tsconfig.json`:
      - `target: "ES2020"`, `module: "ESNext"`, `moduleResolution: "bundler"`, `jsx: "react-jsx"`, `strict: true`
      - include `["src"]`
      - Note: This does NOT extend @jarvis/typescript-config/base.json -- Vite/React needs bundler moduleResolution, not NodeNext
    - Run `pnpm install` from workspace root to link dependencies

    **Vite config (`client/vite.config.ts`):**
    - Import `defineConfig` from `vite`, `react` from `@vitejs/plugin-react`
    - Configure proxy: `/api` routes forwarded to `http://localhost:3001` with `changeOrigin: true`
    - Add SSE proxy configuration: on `proxyReq`, if `accept === 'text/event-stream'`, set `Connection: Keep-Alive` header
    - Set `server.port` to 5173
    - Set `build.outDir` to `../public` -- outputs to `apps/dashboard/public/` where the Hono server's `serveStatic` reads from

    **HTML entry (`client/index.html`):**
    - Standard Vite React HTML with `<div id="root">` and `<script type="module" src="/src/main.tsx">`
    - Title: "Jarvis Dashboard"
    - Include a minimal favicon (or skip)

    **React entry (`client/src/main.tsx`):**
    - Import React, ReactDOM, App, QueryClientProvider, QueryClient
    - Create a QueryClient instance
    - Render `<QueryClientProvider><App /></QueryClientProvider>` into `#root`

    **API helpers (`client/src/lib/api.ts`):**
    - Export `getToken(): string | null` -- reads from `sessionStorage.getItem('dashboard-token')`
    - Export `setToken(token: string): void` -- writes to `sessionStorage`
    - Export `clearToken(): void` -- removes from `sessionStorage`
    - Export `apiFetch(path: string, options?: RequestInit): Promise<Response>` -- wraps fetch with `Authorization: Bearer ${getToken()}` header. If response is 401, calls `clearToken()` and throws.
    - Export `apiJson<T>(path: string, options?: RequestInit): Promise<T>` -- calls apiFetch, parses JSON

    **SSE hook (`client/src/hooks/useSSE.ts`):**
    - Import `fetchEventSource` from `@microsoft/fetch-event-source`
    - Export `useSSE({ token, onStatus, onActivity })`:
      - Use `useEffect` with AbortController
      - Call `fetchEventSource('/api/sse', { headers: { Authorization: Bearer ${token} }, signal, onmessage, onerror })`
      - `onmessage`: parse `ev.data` as JSON, dispatch to `onStatus` or `onActivity` based on `ev.event`
      - `onerror`: if 401 error, throw to stop reconnecting; otherwise let `fetchEventSource` handle automatic reconnect
      - Return cleanup function that aborts the controller
      - Dependency array: `[token]` (reconnect if token changes)

    **TanStack Query hooks (`client/src/hooks/useAgentData.ts`):**
    - Export `useAgentStatus(token: string)`:
      - `useQuery({ queryKey: ['agent-status'], queryFn: () => apiJson('/api/status'), refetchInterval: 5000, staleTime: 2000, enabled: !!token })`
      - This provides fallback polling in case SSE misses an update
    - Export `useKillSwitch()`:
      - `useMutation({ mutationFn: (body: { action, reason }) => apiFetch('/api/kill-switch', { method: 'POST', body: JSON.stringify(body), headers: { 'Content-Type': 'application/json' } }) })`
      - On success, invalidate `['agent-status']` query

    **Auth gate component (`client/src/components/AuthGate.tsx`):**
    - Full-page centered login form with a single password input and "Connect" button
    - On submit: attempt `GET /api/status` with the entered token as Bearer
    - If 200: call `setToken(token)` and render children (the dashboard)
    - If 401: show "Invalid token" error message below the input
    - If token already in sessionStorage: attempt validation on mount (auto-login)
    - Clean, minimal styling -- light background, centered card, generous whitespace
    - Use CSS modules or inline styles (no Tailwind -- keep deps minimal)

    **App container (`client/src/App.tsx`):**
    - Wrap everything in `<AuthGate>`
    - Inside auth gate: tab bar with "Overview" and "Activity" tabs
    - Tab switching via local React state (no router needed for 2 tabs)
    - Default active tab: "Overview"
    - Render `<OverviewTab />` or `<ActivityTab />` (Activity stub for now -- implemented in Plan 03)
    - SSE connection lives here: `useSSE({ token, onStatus: updateStatusCache, onActivity: updateActivityCache })`
    - SSE status updates fed into TanStack Query cache via `queryClient.setQueryData(['agent-status'], ...)` for seamless real-time + polling merge

    **App CSS (`client/src/App.css`):**
    - Clean, minimal base styles per locked decisions: light/neutral theme, generous whitespace, card-based layout
    - System font stack (Inter or system-ui), neutral gray palette
    - Card component: white background, subtle border/shadow, rounded corners
    - Tab bar: horizontal, bottom border for active tab, no background color change
    - Responsive: single column on mobile, comfortable width on desktop (max-width ~1200px, centered)
    - Keep it simple -- the agent will extend the dashboard in Phase 8

    **Critical patterns:**
    - `@microsoft/fetch-event-source` is mandatory for SSE auth -- native EventSource cannot send Authorization headers
    - `sessionStorage` for token (not localStorage) -- clears on tab close for security
    - Client tsconfig uses `moduleResolution: "bundler"` NOT `NodeNext` -- Vite handles module resolution
    - `build.outDir: '../public'` aligns with Hono's `serveStatic({ root: './public' })`
  </action>
  <verify>
    Run `cd /Users/sn0w/Documents/dev/jarvis && pnpm install && pnpm --filter @jarvis/dashboard-client exec tsc --noEmit` to verify TypeScript compilation. Then run `pnpm --filter @jarvis/dashboard-client dev` and verify the Vite dev server starts on port 5173 and shows the auth gate.
  </verify>
  <done>
    React SPA scaffolded with working auth gate, API helpers, SSE hook, and TanStack Query hooks. Vite dev server serves the app on port 5173 with proxy to API server on 3001.
  </done>
</task>

<task type="auto">
  <name>Task 2: Overview tab with status cards and kill switch</name>
  <files>
    apps/dashboard/client/src/components/OverviewTab.tsx
    apps/dashboard/client/src/components/KillSwitchButton.tsx
  </files>
  <action>
    **Overview tab (`client/src/components/OverviewTab.tsx`):**
    - Receives agent status data (from TanStack Query or SSE context) as props or reads from query cache
    - Layout: compact card grid (CSS Grid, 2 columns on desktop, 1 on mobile)
    - **Status card:** Shows alive/halted badge (green dot for alive, red dot for halted), uptime duration (human-readable), last action timestamp
    - **Current goal card:** Shows active goal description or "No active goals" placeholder. If multiple active goals, show the highest-priority one with "(+N more)" indicator
    - **Active strategy card:** Shows active strategy name or "No active strategy" placeholder (strategy data comes from goals table in current implementation)
    - **Recent activity snippet card:** Shows the last 3 activity entries as one-liner summaries (icon + timestamp + short text). Clicking "View all" switches to Activity tab.
    - **Kill switch card:** Contains the `<KillSwitchButton />` component
    - All cards use the card CSS class from App.css
    - Loading state: skeleton placeholders (gray boxes) while data loads
    - Error state: show error message with retry button

    **Kill switch button (`client/src/components/KillSwitchButton.tsx`):**
    - Receives current `isHalted` state as prop
    - If not halted: show red "Kill Switch" button
    - If halted: show green "Resume Agent" button with halt reason displayed above
    - On click: show confirmation dialog (not a browser confirm() -- a styled modal/overlay)
      - For kill: "Are you sure? This will halt all agent activity." with reason text input (required) + Confirm/Cancel buttons
      - For resume: "Are you sure? This will resume all agent activity." with reason text input (required) + Confirm/Cancel buttons
    - On confirm: call `useKillSwitch()` mutation with `{ action: 'activate'|'deactivate', reason }`
    - While mutation pending: disable button, show spinner/loading text
    - On success: close dialog, status update arrives via SSE or query refetch
    - On error: show error message in dialog, keep dialog open for retry

    **Visual style (per locked decisions):**
    - Clean, minimal -- Linear/Vercel aesthetic
    - Light/neutral theme: white cards on #f8f9fa or similar light gray background
    - Generous whitespace between cards (16-24px gaps)
    - Card-based layout with subtle shadows (0 1px 3px rgba(0,0,0,0.1))
    - Status badges: small colored dots (8px) next to text
    - Kill switch button: prominent but not garish -- solid red/green with white text, rounded corners
    - Confirmation dialog: centered overlay with backdrop blur, same card styling
    - Typography: system-ui font stack, 14-16px body text, semibold headings
  </action>
  <verify>
    With both the dashboard API server (`DASHBOARD_TOKEN=test pnpm --filter @jarvis/dashboard dev`) and Vite dev server (`pnpm --filter @jarvis/dashboard-client dev`) running:
    1. Navigate to http://localhost:5173
    2. Enter "test" as the token -- should see the Overview tab
    3. Status cards display (may show empty/default data if DB is empty)
    4. Click "Kill Switch" -- confirmation dialog appears with reason input
    5. Cancel -- dialog closes
    6. Click Kill Switch, enter reason, confirm -- POST to /api/kill-switch succeeds, status updates
  </verify>
  <done>
    Overview tab displays agent status in compact cards (status, current goal, activity snippet, kill switch). Kill switch button works with confirmation dialog. Visual style matches Linear/Vercel aesthetic with light theme, generous whitespace, and card-based layout.
  </done>
</task>

</tasks>

<verification>
1. `pnpm --filter @jarvis/dashboard-client exec tsc --noEmit` passes
2. Auth gate blocks access without valid token
3. Auth gate grants access with valid token (tested against running API server)
4. Overview tab shows agent status cards (alive/halted, current goal, uptime)
5. Kill switch button opens confirmation dialog
6. Kill switch activate/deactivate round-trip works (button -> dialog -> API -> SSE update -> UI reflects change)
7. SSE connection established (visible in browser Network tab as persistent connection)
8. Tab bar switches between Overview and Activity (Activity stub until Plan 03)
</verification>

<success_criteria>
- Operator can authenticate and see the dashboard
- Overview tab displays real-time agent status
- Kill switch works with confirmation pattern
- SSE delivers real-time updates without manual refresh
- Visual style is clean, minimal, card-based (Linear/Vercel aesthetic)
</success_criteria>

<output>
After completion, create `.planning/phases/05-web-dashboard/05-02-SUMMARY.md`
</output>
