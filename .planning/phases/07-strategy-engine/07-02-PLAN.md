---
phase: 07-strategy-engine
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - apps/agent/src/strategy/strategy-prompts.ts
  - apps/agent/src/loop/agent-loop.ts
  - apps/agent/src/loop/evaluator.ts
  - apps/agent/src/multi-agent/supervisor.ts
  - apps/agent/src/index.ts
  - apps/dashboard/src/routes/api.ts
autonomous: true
requirements:
  - STRAT-01
  - STRAT-02
  - STRAT-03
  - STRAT-04
  - STRAT-05
  - STRAT-06
  - STRAT-08

must_haves:
  truths:
    - "Agent receives strategy portfolio context in every sub-goal system prompt"
    - "Portfolio context tells the agent to discover opportunities when capital is idle"
    - "Portfolio context tells the agent to scale winners and kill losers"
    - "Evaluator includes per-strategy P&L in its assessment context"
    - "Supervisor passes strategy context to each AgentLoop it spawns"
    - "StrategyManager is wired into agent startup and accessible during execution"
    - "Operator can seed a goal via dashboard API that becomes the first strategy"
  artifacts:
    - path: "apps/agent/src/strategy/strategy-prompts.ts"
      provides: "Portfolio context prompt builder for LLM injection"
      exports: ["buildPortfolioContextPrompt"]
    - path: "apps/agent/src/loop/agent-loop.ts"
      provides: "Strategy context injection into executeSubGoal system prompt"
      contains: "strategyContext"
    - path: "apps/agent/src/loop/evaluator.ts"
      provides: "P&L context in evaluation assessment"
      contains: "strategyId"
    - path: "apps/agent/src/multi-agent/supervisor.ts"
      provides: "Strategy context passed to spawned AgentLoops"
      contains: "strategyManager"
    - path: "apps/agent/src/index.ts"
      provides: "StrategyManager wired at startup"
      contains: "StrategyManager"
    - path: "apps/dashboard/src/routes/api.ts"
      provides: "Goal seeding endpoint for operator"
      contains: "strategies"
  key_links:
    - from: "apps/agent/src/strategy/strategy-prompts.ts"
      to: "apps/agent/src/loop/agent-loop.ts"
      via: "buildPortfolioContextPrompt called and injected into system prompt"
      pattern: "buildPortfolioContextPrompt"
    - from: "apps/agent/src/multi-agent/supervisor.ts"
      to: "apps/agent/src/strategy/strategy-manager.ts"
      via: "Supervisor uses StrategyManager to get portfolio context per goal"
      pattern: "strategyManager"
    - from: "apps/agent/src/index.ts"
      to: "apps/agent/src/strategy/strategy-manager.ts"
      via: "StrategyManager instantiated at startup"
      pattern: "new StrategyManager"
---

<objective>
Wire the strategy engine into the agent's autonomous loop so the LLM receives portfolio context in every planning cycle, can discover/create/evaluate/kill strategies, and the operator can seed goals.

Purpose: The data model from Plan 01 is inert without integration. This plan makes strategies visible to the LLM by injecting portfolio context into every sub-goal prompt, augments the evaluator with P&L awareness, and wires the StrategyManager into the agent's startup sequence. The operator can seed the initial goal that triggers strategy discovery.

Output: Portfolio prompt builder, agent-loop strategy context injection, evaluator P&L augmentation, supervisor strategy wiring, startup integration, and a goal-seeding dashboard API endpoint.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-strategy-engine/07-RESEARCH.md
@.planning/phases/07-strategy-engine/07-01-SUMMARY.md

@apps/agent/src/loop/agent-loop.ts
@apps/agent/src/loop/evaluator.ts
@apps/agent/src/multi-agent/supervisor.ts
@apps/agent/src/index.ts
@apps/agent/src/strategy/strategy-manager.ts
@apps/dashboard/src/routes/api.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create portfolio prompt builder and inject strategy context into agent loop and evaluator</name>
  <files>
    apps/agent/src/strategy/strategy-prompts.ts
    apps/agent/src/loop/agent-loop.ts
    apps/agent/src/loop/evaluator.ts
  </files>
  <action>
    **Create `apps/agent/src/strategy/strategy-prompts.ts`:**

    This module builds a compact portfolio summary that gets injected into every sub-goal system prompt. Must stay under ~500 tokens to avoid context window overflow (research pitfall #5).

    ```typescript
    import type { StrategyWithPnl } from './strategy-manager.js';
    ```

    **`buildPortfolioContextPrompt(strategies: StrategyWithPnl[]): string`**

    If strategies array is empty, return:
    ```
    STRATEGY PORTFOLIO: Empty. No strategies active.
    You should discover new opportunities to pursue your goal.
    Use web research (http tool, browser tools) to find opportunities.
    When you find a promising opportunity, create a new strategy hypothesis.
    ```

    If strategies exist, build a compact summary:
    ```
    STRATEGY PORTFOLIO:
      [1] HYPOTHESIS: Sell AI-generated art on Etsy...
           Capital: $0.00 | Revenue: $0.00 | Costs: $0.12 | Net P&L: -$0.12
           Goal #5
      [2] TESTING: Offer freelance data analysis on Upwork...
           Capital: $25.00 | Revenue: $15.00 | Costs: $3.50 | Net P&L: $11.50
           Goal #8

    PORTFOLIO GUIDANCE:
    - Scale strategies with positive P&L by allocating more capital
    - Kill strategies with persistent negative P&L — update status to 'killed' with reasoning
    - Discover new opportunities when capital is idle or all strategies are underperforming
    - Transition 'hypothesis' strategies to 'testing' when ready to commit capital
    - Only legal strategies are permitted — no exceptions
    ```

    Keep it to one line per strategy with essential metrics. The agent can always query the `db` tool for full details. Truncate hypothesis text to 80 chars.

    **Modify `apps/agent/src/loop/agent-loop.ts`:**

    Add an optional `strategyContext?: string` parameter to the `AgentLoop` constructor (add it to `AgentLoopConfig` or as a separate constructor param — use a config field for cleanliness):

    Add to `AgentLoopConfig`:
    ```typescript
    /** Strategy portfolio context to inject into sub-goal system prompts */
    strategyContext?: string;
    ```

    Store as `private readonly strategyContext: string | undefined` in the constructor.

    In `executeSubGoal()`, inject the strategy context into the system prompt AFTER the sub-goal description and BEFORE the constraints section. Only inject if `this.strategyContext` is defined and non-empty:

    ```typescript
    const systemParts = [
      `You are an autonomous AI agent executing a specific sub-goal.`,
      ``,
      `SUB-GOAL: ${subGoal.description}`,
      ``,
    ];

    if (this.strategyContext) {
      systemParts.push(this.strategyContext, '');
    }

    systemParts.push(
      `CONSTRAINTS:`,
      // ... existing constraints
    );
    ```

    This replaces the existing hardcoded system prompt string array with the dynamic version. Keep all existing constraint text unchanged.

    **Modify `apps/agent/src/loop/evaluator.ts`:**

    Add strategy P&L awareness to `EvaluatorImpl.evaluateOutcome()`. Extend the LLM evaluation prompt (Step 2) to include strategy context when available.

    Add an optional `strategyPnlContext?: string` parameter to `evaluateOutcome()` (extend the method signature — add it as a 4th parameter with default undefined). Update the `Evaluator` interface to match.

    In the LLM evaluation prompt (Step 2), append the strategy context if provided:
    ```typescript
    const evalParts = [
      `Goal: ${goalDescription}`,
      `Sub-goal: ${subGoal.description}`,
      `Outcome: ${JSON.stringify(outcome)}`,
    ];

    if (strategyPnlContext) {
      evalParts.push('', `Strategy P&L Context:`, strategyPnlContext);
    }

    evalParts.push(
      '',
      'Evaluate: Did this outcome move us toward the goal? ...',
      // ... rest of existing prompt
    );
    ```

    This lets the evaluator factor in P&L when assessing whether a sub-goal outcome is acceptable.

    **Do NOT:**
    - Add any hard-coded kill thresholds or auto-kill logic to the evaluator — the LLM decides
    - Remove existing metric-based triggers in the evaluator — they are complementary
    - Make strategyContext a required parameter — backwards compatibility with non-strategy goals

    **Run `pnpm --filter @jarvis/agent build`** to verify TypeScript compilation.
  </action>
  <verify>
    `pnpm --filter @jarvis/agent build` succeeds with no TypeScript errors.
    `buildPortfolioContextPrompt` is exported from `strategy-prompts.ts`.
    `AgentLoop` constructor accepts `strategyContext` via config.
    `executeSubGoal()` system prompt includes strategy context when provided.
    `EvaluatorImpl.evaluateOutcome()` accepts optional `strategyPnlContext` parameter.
  </verify>
  <done>
    Portfolio prompt builder creates compact strategy summaries with P&L and guidance directives. AgentLoop injects strategy context into every sub-goal system prompt. Evaluator includes P&L context in LLM evaluation when available. All changes are backwards-compatible — non-strategy goals work exactly as before.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire StrategyManager into Supervisor, agent startup, and add goal-seeding API</name>
  <files>
    apps/agent/src/multi-agent/supervisor.ts
    apps/agent/src/index.ts
    apps/dashboard/src/routes/api.ts
  </files>
  <action>
    **Modify `apps/agent/src/multi-agent/supervisor.ts`:**

    Add `StrategyManager` as an optional constructor parameter (keeps backwards compat). Import:
    ```typescript
    import type { StrategyManager } from '../strategy/strategy-manager.js';
    import { buildPortfolioContextPrompt } from '../strategy/strategy-prompts.js';
    ```

    Add to constructor: `private readonly strategyManager?: StrategyManager` (add as the last parameter before `config?`).

    Modify `spawnMainAgent()`:
    - Before creating the `AgentLoop`, check if a strategy exists for this goal via `strategyManager.getStrategyByGoalId(goalId)`
    - If a strategy exists, build the portfolio context: `const portfolio = await strategyManager.getPortfolioContext();` then `const strategyContext = buildPortfolioContextPrompt(portfolio);`
    - Pass `strategyContext` to the `AgentLoop` constructor via the config parameter
    - If no strategy exists for this goal (e.g., a plain goal without strategy metadata), pass `undefined` for strategyContext — the AgentLoop works the same as before

    The existing `AgentLoop` constructor already accepts config as the last param. Pass `strategyContext` in the config object:
    ```typescript
    const agentLoop = new AgentLoop(
      this.router,
      this.registry,
      this.killSwitch,
      this.db,
      this.goalManager,
      this.tools,
      this.evaluator,
      this.replanner,
      { strategyContext },
    );
    ```

    **Modify `apps/agent/src/index.ts`:**

    Import StrategyManager:
    ```typescript
    import { StrategyManager } from './strategy/strategy-manager.js';
    ```

    After the GoalManager creation (`const goalManager = new GoalManager(db, router);`), create the StrategyManager:
    ```typescript
    const strategyManager = new StrategyManager(db, goalManager);
    ```

    Pass `strategyManager` to the Supervisor constructor (add as additional arg before the config param — align with the updated constructor signature):
    ```typescript
    const supervisor = new Supervisor(
      db, router, registry, killSwitch, goalManager,
      evaluator, replanner, openAITools, strategyManager,
    );
    ```

    Add a stderr log line after creation:
    ```typescript
    process.stderr.write('[agent] StrategyManager wired into Supervisor.\n');
    ```

    **Modify `apps/dashboard/src/routes/api.ts`:**

    First, check if this file exists by reading it. The dashboard API was created in Phase 5 (Plan 01). Add a POST endpoint for operator goal seeding.

    Add a new route: `POST /api/goals` that accepts `{ description: string, isStrategy?: boolean }`:
    - Creates a goal via GoalManager (or via direct DB insert using `goals` table import)
    - If `isStrategy` is true, also creates a strategy row via `strategies` table insert with `status: 'hypothesis'` and `hypothesis: description`
    - Returns `{ goalId, strategyId? }` as JSON

    Since the dashboard API may not have direct access to GoalManager (it's in apps/agent), use direct DB operations:
    ```typescript
    import { db, goals, strategies } from '@jarvis/db';
    ```

    The route:
    ```typescript
    app.post('/api/goals', async (c) => {
      const { description, isStrategy } = await c.req.json<{ description: string; isStrategy?: boolean }>();

      if (!description || typeof description !== 'string') {
        return c.json({ error: 'description is required' }, 400);
      }

      const [goal] = await db.insert(goals).values({
        description,
        source: 'operator-injected',
        priority: 50,
      }).returning();

      let strategyId: number | undefined;
      if (isStrategy && goal) {
        const [strategy] = await db.insert(strategies).values({
          goalId: goal.id,
          hypothesis: description,
          status: 'hypothesis',
          capitalAllocatedUsd: '0',
        }).returning();
        strategyId = strategy?.id;
      }

      return c.json({ goalId: goal?.id, strategyId });
    });
    ```

    Also add a `GET /api/strategies` route that returns the strategy portfolio with P&L:
    ```typescript
    app.get('/api/strategies', async (c) => {
      const rows = await db.select().from(strategies).orderBy(asc(strategies.createdAt));
      const withPnl = await Promise.all(rows.map(async (s) => {
        const pnl = await getPnl(db, { strategyId: s.id });
        return { ...s, ...pnl };
      }));
      return c.json(withPnl);
    });
    ```

    Import `getPnl`, `asc` from `@jarvis/db`.

    **Run `pnpm --filter @jarvis/agent build && pnpm --filter @jarvis/dashboard build`** to verify everything compiles.
  </action>
  <verify>
    `pnpm --filter @jarvis/agent build` succeeds with no TypeScript errors.
    `pnpm --filter @jarvis/dashboard build` succeeds with no TypeScript errors.
    Supervisor constructor accepts optional StrategyManager parameter.
    Supervisor.spawnMainAgent builds portfolio context and passes it to AgentLoop when a strategy exists for the goal.
    StrategyManager is instantiated in apps/agent/src/index.ts and passed to Supervisor.
    `POST /api/goals` creates a goal (and optionally a strategy) and returns IDs.
    `GET /api/strategies` returns strategy list with P&L data.
  </verify>
  <done>
    Supervisor passes portfolio context to every AgentLoop it spawns for strategy-backed goals. StrategyManager is wired at agent startup. Dashboard API has POST /api/goals for operator goal seeding (with optional strategy creation) and GET /api/strategies for portfolio viewing. The agent receives full portfolio context in every sub-goal prompt, enabling LLM-driven strategy discovery, evaluation, scaling, and killing.
  </done>
</task>

</tasks>

<verification>
1. `pnpm --filter @jarvis/db build && pnpm --filter @jarvis/agent build && pnpm --filter @jarvis/dashboard build` — all compile clean
2. `AgentLoop.executeSubGoal()` system prompt includes portfolio context when available
3. Supervisor resolves strategy context per-goal before spawning AgentLoop
4. StrategyManager wired in agent startup (apps/agent/src/index.ts)
5. `POST /api/goals` creates goal + optional strategy
6. `GET /api/strategies` returns strategies with P&L
7. No hard-coded kill triggers or strategy-level spend limits exist anywhere
8. Non-strategy goals continue to work exactly as before (backwards compatible)
</verification>

<success_criteria>
- Agent receives strategy portfolio context in every sub-goal prompt
- Portfolio context includes guidance for discovering, scaling, and killing strategies
- Evaluator has P&L context for strategy-aware evaluation
- Supervisor resolves and passes portfolio context to each AgentLoop
- StrategyManager wired at startup
- Operator can seed goals via dashboard API
- All changes backwards-compatible with existing non-strategy goals
</success_criteria>

<output>
After completion, create `.planning/phases/07-strategy-engine/07-02-SUMMARY.md`
</output>
