---
phase: 06-browser-identity-and-bootstrapping
plan: 04
type: execute
wave: 3
depends_on: ["06-02", "06-03"]
files_modified:
  - packages/tools/src/bootstrap/install-package.ts
  - packages/tools/src/bootstrap/discover-tool.ts
  - packages/tools/src/bootstrap/index.ts
  - packages/tools/src/index.ts
  - apps/agent/src/index.ts
  - apps/agent/src/shutdown.ts
  - apps/agent/package.json
  - apps/dashboard/src/routes/identities.ts
  - apps/dashboard/src/app.ts
autonomous: true
requirements:
  - BOOT-01
  - BOOT-02
  - BOOT-03
  - BOOT-04
  - IDENT-06

user_setup:
  - service: 2captcha
    why: "CAPTCHA solving for browser automation (optional â€” agent degrades gracefully without it)"
    env_vars:
      - name: TWO_CAPTCHA_API_KEY
        source: "2captcha.com -> Dashboard -> API Key"
  - service: credential-encryption
    why: "Encrypts all credentials stored in the vault"
    env_vars:
      - name: CREDENTIAL_ENCRYPTION_KEY
        source: "Generate a random 32+ character string (e.g., openssl rand -base64 32)"

must_haves:
  truths:
    - "Agent can install an npm package at runtime and import it dynamically without restart"
    - "Agent can discover available tools and evaluate whether to install new packages"
    - "All Phase 6 tools are registered in the agent's ToolRegistry at startup"
    - "Browser process is cleaned up on agent shutdown"
    - "Identity ledger is visible on the dashboard via API endpoint"
    - "Agent runs without operator intervention for all Phase 6 capabilities (except real-identity escalation)"
  artifacts:
    - path: "packages/tools/src/bootstrap/install-package.ts"
      provides: "package_install ToolDefinition for runtime npm install"
      exports: ["createInstallPackageTool"]
    - path: "packages/tools/src/bootstrap/discover-tool.ts"
      provides: "tool_discover ToolDefinition for tool discovery"
      exports: ["createDiscoverToolTool"]
    - path: "packages/tools/src/bootstrap/index.ts"
      provides: "createBootstrapTools factory"
      exports: ["createBootstrapTools"]
    - path: "apps/agent/src/index.ts"
      provides: "Phase 6 tool registration and browser lifecycle wiring"
      contains: "createBrowserTools|createIdentityTools|createBootstrapTools"
    - path: "apps/dashboard/src/routes/identities.ts"
      provides: "GET /api/identities and GET /api/identities/:id/accounts endpoints"
      exports: ["default"]
  key_links:
    - from: "packages/tools/src/bootstrap/install-package.ts"
      to: "pnpm"
      via: "spawn('pnpm', ['add', pkg]) in project root"
      pattern: "spawn.*pnpm.*add"
    - from: "packages/tools/src/bootstrap/install-package.ts"
      to: "ESM dynamic import"
      via: "await import(packageName) after install"
      pattern: "import\\("
    - from: "apps/agent/src/index.ts"
      to: "@jarvis/browser"
      via: "BrowserManager lifecycle in agent process"
      pattern: "BrowserManager"
    - from: "apps/agent/src/shutdown.ts"
      to: "@jarvis/browser"
      via: "browser.close() in shutdown handler"
      pattern: "browserManager|browser.*close"
    - from: "apps/dashboard/src/routes/identities.ts"
      to: "@jarvis/db"
      via: "SELECT from identities + identity_accounts tables"
      pattern: "identities|identityAccounts"
---

<objective>
Create the self-bootstrapping tool group (runtime package install, tool discovery), wire all Phase 6 tools into the agent process, add browser cleanup to shutdown, and expose the identity ledger on the dashboard API.

Purpose: This completes Phase 6 by connecting all pieces: bootstrap tools enable self-provisioning (BOOT-01 through BOOT-04), agent wiring registers all 17+ new tools, browser cleanup prevents zombie processes, and the dashboard identity ledger lets the operator audit created accounts (IDENT-06).

Output: 2 bootstrap ToolDefinitions, updated agent index.ts with Phase 6 bootstrap, updated shutdown.ts with browser cleanup, identity ledger API route.

NOTE: Browser Use and DevTools MCP are not pre-integrated in these plans. This is intentional -- the package_install tool (BOOT-01) enables the agent to install and integrate these libraries at runtime when it determines they would be useful. The locked decision says "agent should leverage tools like Browser Use and DevTools MCP when available" -- the self-provisioning capability satisfies this by letting the agent install them on-demand rather than bundling them upfront.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-browser-identity-and-bootstrapping/06-RESEARCH.md
@.planning/phases/06-browser-identity-and-bootstrapping/06-01-SUMMARY.md
@.planning/phases/06-browser-identity-and-bootstrapping/06-02-SUMMARY.md
@.planning/phases/06-browser-identity-and-bootstrapping/06-03-SUMMARY.md
@apps/agent/src/index.ts
@apps/agent/src/shutdown.ts
@apps/agent/package.json
@apps/dashboard/src/app.ts
@apps/dashboard/src/routes/status.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create bootstrap tools (runtime package install + tool discovery)</name>
  <files>
    packages/tools/src/bootstrap/install-package.ts
    packages/tools/src/bootstrap/discover-tool.ts
    packages/tools/src/bootstrap/index.ts
    packages/tools/src/index.ts
  </files>
  <action>
Create packages/tools/src/bootstrap/ directory with three files:

**install-package.ts**: `createInstallPackageTool()` factory returning ToolDefinition.
- Name: 'package_install'
- Input: { packageSpec: string (e.g. 'lodash', 'axios@1.7.0'), importAfterInstall?: boolean (default true) }
- Implementation:
  1. Determine PROJECT_ROOT: use `new URL('../../../../../', import.meta.url).pathname` to get monorepo root (from packages/tools/src/bootstrap/ that's 5 levels up). Alternatively, find the root by looking for pnpm-workspace.yaml. The most reliable approach: use `process.cwd()` (agent process runs from project root) or hardcode a path resolution.
  2. Spawn pnpm: `spawn('pnpm', ['add', packageSpec], { cwd: projectRoot, stdio: ['ignore', 'pipe', 'pipe'], shell: false })` -- shell: false per project decision
  3. Collect stdout/stderr from the process
  4. On success (exit code 0): if importAfterInstall, attempt `await import(packageName)` where packageName is the spec without version (split on '@' handling scoped packages like @scope/name@version)
  5. Returns: { installed: true, packageSpec, imported: boolean, exports?: string[] } -- try to list top-level exports of the imported module via Object.keys()
  6. On failure: returns { installed: false, error: stderr, exitCode }
  7. Timeout: 120 seconds (pnpm install can be slow for large packages)
- Per locked decision: fully autonomous npm installation, no approval required. Packages persist permanently.
- Parse package name from spec: if spec starts with '@', it's scoped -- split by '/' then by '@' for version. E.g., '@faker-js/faker@9.0.0' -> packageName = '@faker-js/faker'. 'lodash@4.17.21' -> 'lodash'. 'express' -> 'express'.
- This tool is the mechanism by which the agent can self-install Browser Use, DevTools MCP, or any other library it discovers it needs at runtime.

**discover-tool.ts**: `createDiscoverToolTool(registry)` factory taking ToolRegistry instance.
- Name: 'tool_discover'
- Input: { query?: string (optional filter by name/description) }
- Lists all currently registered tools via registry.list()
- If query provided, filters by name.includes(query) or description containing query (case-insensitive)
- Returns: { tools: Array<{ name: string, description: string, inputSchema: object }>, count: number }
- This helps the agent inspect its own capabilities and decide what's missing (BOOT-02)

**index.ts**: Barrel export + convenience factory:
```typescript
export { createInstallPackageTool } from './install-package.js';
export { createDiscoverToolTool } from './discover-tool.js';

import type { ToolRegistry } from '../registry.js';
import type { ToolDefinition } from '../types.js';

export function createBootstrapTools(registry: ToolRegistry): ToolDefinition<any, any>[] {
  return [
    createInstallPackageTool(),
    createDiscoverToolTool(registry),
  ];
}
```

**Update packages/tools/src/index.ts**: Add bootstrap exports:
```typescript
// Bootstrap tools (Phase 06)
export { createBootstrapTools } from './bootstrap/index.js';
```
  </action>
  <verify>
1. `pnpm --filter @jarvis/tools run build` exits 0
2. `pnpm --filter @jarvis/tools exec tsx -e "import { createBootstrapTools } from './src/bootstrap/index.js'; import { ToolRegistry } from './src/registry.js'; const r = new ToolRegistry(); const tools = createBootstrapTools(r); console.log('Bootstrap tools:', tools.length, tools.map(t => t.name)); process.exit(0);"` -- prints 2 tools
3. Verify install-package works (dry test): parse package name from '@faker-js/faker@9.0.0' yields '@faker-js/faker'
  </verify>
  <done>
Bootstrap tool group complete: package_install (pnpm add + dynamic import) and tool_discover (registry introspection). Both exported via createBootstrapTools(registry) factory. Build passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire Phase 6 tools into agent process, shutdown handler, and dashboard identity API</name>
  <files>
    apps/agent/src/index.ts
    apps/agent/src/shutdown.ts
    apps/agent/package.json
    apps/dashboard/src/routes/identities.ts
    apps/dashboard/src/app.ts
  </files>
  <action>
**apps/agent/package.json**: Add @jarvis/browser as a dependency. It's needed for BrowserManager instantiation in the agent process.

**apps/agent/src/index.ts**: Add Phase 6 tool registration section AFTER the Phase 4 wallet section and BEFORE the shutdown handler registration. Follow the same pattern as wallet integration (optional, graceful degradation):

```typescript
// === Phase 6: Browser, Identity, and Bootstrapping ===
import { BrowserManager } from '@jarvis/browser';
import { createBrowserTools, createIdentityTools, createBootstrapTools } from '@jarvis/tools';

// Browser manager lifecycle (always available -- no env var gating)
const browserManager = new BrowserManager();

// Register browser tools (8 tools: session open/close/save, navigate, click, fill, extract, screenshot)
const browserTools = createBrowserTools(browserManager);
browserTools.forEach((t) => registry.register(t));

// Register identity tools (7 tools: identity_create, credential_store/retrieve, temp_email_create/check, identity_retire, request_operator_credentials)
const identityTools = createIdentityTools(db);
identityTools.forEach((t) => registry.register(t));

// Register bootstrap tools (2 tools: package_install, tool_discover)
const bootstrapTools = createBootstrapTools(registry);
bootstrapTools.forEach((t) => registry.register(t));

// Re-derive openAITools after Phase 6 registration (same pattern as wallet)
openAITools = toolDefinitionsToOpenAI(registry);

// Validate CREDENTIAL_ENCRYPTION_KEY at startup (warn, don't crash -- identity tools degrade gracefully)
if (!process.env.CREDENTIAL_ENCRYPTION_KEY) {
  process.stderr.write('[agent] WARNING: CREDENTIAL_ENCRYPTION_KEY not set -- credential vault tools will fail. Set this env var to enable encrypted credential storage.\n');
}

process.stderr.write(`[agent] Phase 6 ready. Browser: ${browserTools.length} tools, Identity: ${identityTools.length} tools, Bootstrap: ${bootstrapTools.length} tools. Total: ${registry.count()}\n`);
```

**apps/agent/src/shutdown.ts**: Add browser cleanup.

Add new interface:
```typescript
export interface ShutdownBrowserManager {
  close(): Promise<void>;
  isRunning(): boolean;
}
```

Add `browserManager?: ShutdownBrowserManager` to ShutdownResources.

In gracefulShutdown(), add browser close AFTER wallet subscription stop and BEFORE supervisor stop:
```typescript
// 2.5. Close browser (kills Chromium child process -- prevents zombie per research Pitfall 6)
if (browserManager !== undefined && browserManager.isRunning()) {
  await browserManager.close();
  process.stderr.write('[shutdown] Browser closed.\n');
}
```

Update the registerShutdownHandlers call in index.ts to include browserManager.

**apps/dashboard/src/routes/identities.ts**: New Hono route module for identity ledger (IDENT-06: operator can audit identities).

Create a new Hono() app with two routes:

`GET /identities` -- List all identities with pagination:
- Query params: limit (default 50), offset (default 0), status (optional filter: 'active'|'suspended'|'retired'|'archived')
- SELECT id, name, email, status, risk_score, created_at, retired_at FROM identities ORDER BY created_at DESC LIMIT ${limit} OFFSET ${offset}
- If status filter: add WHERE status = ${status}
- Returns: { identities: [...], total: count }

`GET /identities/:id/accounts` -- List accounts for a specific identity:
- SELECT * FROM identity_accounts WHERE identity_id = ${id} ORDER BY created_at DESC
- Also SELECT id, service, key, status, created_at, expires_at FROM credentials WHERE identity_id = ${id} (metadata only, NO encrypted values)
- Also SELECT * FROM credential_access_audit WHERE identity_id = ${id} ORDER BY accessed_at DESC LIMIT 100
- Returns: { identity: {...}, accounts: [...], credentials: [...], auditLog: [...] }

Import sql and schema tables from @jarvis/db.

**apps/dashboard/src/app.ts**: Mount the identity routes:
```typescript
import identities from './routes/identities.js';
// ...
app.route('/api', identities);
```

Mount BEFORE the serveStatic middleware (per Phase 5 decision: API routes before static).
  </action>
  <verify>
1. `pnpm --filter @jarvis/agent run build` exits 0
2. `pnpm --filter @jarvis/dashboard run build` exits 0
3. Verify Phase 6 tool count: start agent briefly and check stderr output for Phase 6 ready message with correct tool counts
4. Verify identity API: `curl -H "Authorization: Bearer ${DASHBOARD_TOKEN}" http://localhost:3001/api/identities` returns 200 with { identities: [], total: 0 }
5. Verify shutdown.ts compiles with ShutdownBrowserManager
  </verify>
  <done>
Agent process registers all Phase 6 tools (browser: 8, identity: 7, bootstrap: 2 = 17 new tools). Browser cleanup wired into shutdown handler. Dashboard exposes identity ledger API (GET /api/identities, GET /api/identities/:id/accounts). CREDENTIAL_ENCRYPTION_KEY validated at startup with warning. All builds pass.
  </done>
</task>

</tasks>

<verification>
1. `pnpm --filter @jarvis/tools run build && pnpm --filter @jarvis/agent run build && pnpm --filter @jarvis/dashboard run build` -- all three build
2. Agent startup shows Phase 6 tools registered (17 new tools)
3. Browser shutdown handler in place
4. Dashboard identity ledger API responds
5. package_install tool can install a trivial package (e.g., 'is-odd') and dynamic import succeeds
</verification>

<success_criteria>
- package_install installs npm packages at runtime via pnpm add and loads them via dynamic import
- tool_discover lists all registered tools from the registry
- Agent index.ts bootstraps BrowserManager, registers all Phase 6 tools, re-derives openAITools
- Browser is closed on agent shutdown (no zombie Chromium processes)
- Dashboard GET /api/identities returns identity ledger data
- CREDENTIAL_ENCRYPTION_KEY absence triggers a warning (not a crash)
- BOOT-03 satisfied: browser automation (Plan 03) + identity tools (Plan 02) compose to enable service signup
- BOOT-04 satisfied: all flows automated, only Discord DM escalation for real-human identity requirements
- Browser Use / DevTools MCP integration deferred to agent runtime -- package_install enables on-demand installation
</success_criteria>

<output>
After completion, create `.planning/phases/06-browser-identity-and-bootstrapping/06-04-SUMMARY.md`
</output>
