---
phase: 12-isolated-sandbox-verification
plan: 02
type: execute
wave: 2
depends_on:
  - 12-01
files_modified:
  - packages/tools/src/self-extension/verification-policy.ts
  - packages/tools/src/self-extension/isolated-verifier.ts
  - packages/tools/src/self-extension/staging-deployer.ts
  - packages/tools/src/self-extension/index.ts
autonomous: true
requirements:
  - SEXT-09
  - SEXT-10
  - SEXT-11
must_haves:
  truths:
    - "Builtin candidate verification runs in an isolated workspace instead of the live runtime checkout."
    - "Verification executes required stage sequence (compile, targetedTests, startupSmoke) with fail-closed behavior."
    - "Staging flow blocks promotion when any required verification stage is not successful."
  artifacts:
    - path: "packages/tools/src/self-extension/verification-policy.ts"
      provides: "Deterministic mapping from changed files to compile/test/smoke commands and stage bounds"
      exports: ["buildVerificationPlan"]
    - path: "packages/tools/src/self-extension/isolated-verifier.ts"
      provides: "Orchestrator that runs stage policy inside isolated worktree and returns typed diagnostics"
      exports: ["runIsolatedVerification"]
    - path: "packages/tools/src/self-extension/staging-deployer.ts"
      provides: "Builtin staging path that invokes isolated verifier before repository promotion flow"
      pattern: "runIsolatedVerification"
  key_links:
    - from: "packages/tools/src/self-extension/staging-deployer.ts"
      to: "packages/tools/src/self-extension/isolated-verifier.ts"
      via: "builtin modify execution delegates verification decision to isolated verifier result"
      pattern: "runIsolatedVerification"
    - from: "packages/tools/src/self-extension/isolated-verifier.ts"
      to: "packages/tools/src/self-extension/workspace-isolation.ts"
      via: "isolated verifier creates and tears down worktree per run"
      pattern: "createIsolatedWorktree"
    - from: "packages/tools/src/self-extension/isolated-verifier.ts"
      to: "packages/tools/src/self-extension/verification-policy.ts"
      via: "stage command plan derived from changed file path and requirement contract"
      pattern: "buildVerificationPlan"
---

<objective>
Build and integrate the isolated verifier pipeline with deterministic stage policy and promotion gating hooks.

Purpose: SEXT-09/10/11 require workspace isolation plus required compile/test/smoke stage execution before promotion decisions.
Output: An isolated verifier module and staging integration that fail closed on incomplete verification.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/12-isolated-sandbox-verification/12-RESEARCH.md
@.planning/phases/12-isolated-sandbox-verification/12-01-PLAN.md
@packages/tools/src/self-extension/workspace-isolation.ts
@packages/tools/src/self-extension/bounded-command.ts
@packages/tools/src/self-extension/verification-diagnostics.ts
@packages/tools/src/self-extension/staging-deployer.ts
@packages/tools/src/self-extension/github-pipeline.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement deterministic verification policy for compile, targeted tests, and startup smoke</name>
  <files>
    packages/tools/src/self-extension/verification-policy.ts
    packages/tools/src/self-extension/index.ts
  </files>
  <action>
1. Add `verification-policy.ts` to derive stage commands from candidate file path/workspace context.
2. Define required stages exactly as `compile`, `targetedTests`, and `startupSmoke`, each with:
   - command argv,
   - cwd,
   - timeout/resource bounds,
   - required/optional semantics.
3. Implement conservative/fail-closed defaults for unknown paths (do not silently skip required checks).
4. Export policy builder through self-extension index for verifier integration.
  </action>
  <verify>
    - `pnpm --filter @jarvis/tools build` succeeds.
    - `rg -n "compile|targetedTests|startupSmoke|buildVerificationPlan" packages/tools/src/self-extension/verification-policy.ts` confirms required stage policy.
  </verify>
  <done>Verifier stage policy is deterministic, path-aware, and requirement-aligned for SEXT-11.</done>
</task>

<task type="auto">
  <name>Task 2: Create isolated verifier orchestrator that executes stage policy inside worktree</name>
  <files>
    packages/tools/src/self-extension/isolated-verifier.ts
    packages/tools/src/self-extension/index.ts
  </files>
  <action>
1. Implement `runIsolatedVerification` that:
   - provisions isolated workspace via `workspace-isolation`,
   - applies candidate content in that workspace,
   - executes stage commands via `runBoundedCommand`,
   - records typed diagnostics per stage and run.
2. Enforce fail-closed semantics: timeout, spawn errors, missing required stage results, or non-zero exits produce overall failure.
3. Ensure deterministic cleanup in `finally` regardless of pass/fail/throw.
4. Return diagnostics payload and an evidence summary suitable for staging/promotion consumption.
  </action>
  <verify>
    - `pnpm --filter @jarvis/tools build` succeeds.
    - `rg -n "runIsolatedVerification|cleanupIsolatedWorktree|overallStatus|stages" packages/tools/src/self-extension/isolated-verifier.ts` confirms orchestration and cleanup.
  </verify>
  <done>Self-extension has an isolated verifier that executes required stages in a temporary workspace and returns structured outcomes.</done>
</task>

<task type="auto">
  <name>Task 3: Integrate isolated verifier into builtin staging flow and block promotion on verification failure</name>
  <files>
    packages/tools/src/self-extension/staging-deployer.ts
  </files>
  <action>
1. Replace direct single-run sandbox verification gate with `runIsolatedVerification` as the authoritative pre-promotion check for builtin changes.
2. Preserve compile/tool-level safety ordering while ensuring repository promotion path only executes after verifier pass.
3. Map verifier outputs into stage result:
   - success path includes verification evidence summary,
   - failure path returns explicit verifier failure reason and diagnostics reference.
4. Keep the GitHub promotion integration contract intact for downstream steps (branch/PR/status logic unchanged apart from new verifier evidence input).
  </action>
  <verify>
    - `pnpm --filter @jarvis/tools build` succeeds.
    - `rg -n "runIsolatedVerification|verification|promotionAttempted" packages/tools/src/self-extension/staging-deployer.ts` confirms verifier gating integration.
  </verify>
  <done>Builtin staging now depends on isolated multi-stage verification and fails closed before promotion if any required check fails.</done>
</task>

</tasks>

<verification>
- `pnpm --filter @jarvis/tools build`
- Manual smoke: invoke isolated verifier on a safe fixture change and confirm worktree cleanup after completion
- Confirm staging path does not call promotion pipeline when verifier status is failed/timeout/error
</verification>

<success_criteria>
Isolated verifier orchestration is integrated into builtin staging and enforces required compile/test/smoke verification before promotion can proceed.
</success_criteria>

<output>
After completion, create `.planning/phases/12-isolated-sandbox-verification/12-02-SUMMARY.md`
</output>
