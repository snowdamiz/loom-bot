---
phase: 12-isolated-sandbox-verification
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/tools/src/self-extension/workspace-isolation.ts
  - packages/tools/src/self-extension/bounded-command.ts
  - packages/tools/src/self-extension/verification-diagnostics.ts
  - packages/tools/src/self-extension/index.ts
autonomous: true
requirements:
  - SEXT-09
  - SEXT-10
  - SEXT-12
must_haves:
  truths:
    - "Verification foundations can create and tear down isolated candidate workspaces without mutating the live checkout."
    - "Verifier subprocesses enforce timeout, kill, and bounded output guarantees so failures cannot wedge the parent loop."
    - "Stage outcomes are represented in a typed diagnostics contract that downstream staging and tool payloads can consume."
  artifacts:
    - path: "packages/tools/src/self-extension/workspace-isolation.ts"
      provides: "Isolated git worktree lifecycle helpers with deterministic cleanup and error reporting"
      exports: ["createIsolatedWorktree", "cleanupIsolatedWorktree"]
    - path: "packages/tools/src/self-extension/bounded-command.ts"
      provides: "Shared bounded subprocess runner with timeout/resource/output controls"
      exports: ["runBoundedCommand"]
    - path: "packages/tools/src/self-extension/verification-diagnostics.ts"
      provides: "Typed diagnostics model for verifier stage and run-level outcomes"
      exports: ["VerificationRunResult", "VerificationStageResult"]
  key_links:
    - from: "packages/tools/src/self-extension/workspace-isolation.ts"
      to: "packages/tools/src/self-extension/bounded-command.ts"
      via: "worktree add/remove/prune shell-outs run through bounded command wrapper"
      pattern: "git worktree"
    - from: "packages/tools/src/self-extension/bounded-command.ts"
      to: "packages/tools/src/self-extension/verification-diagnostics.ts"
      via: "command execution output normalized into stage diagnostics fields"
      pattern: "durationMs"
    - from: "packages/tools/src/self-extension/index.ts"
      to: "packages/tools/src/self-extension/workspace-isolation.ts"
      via: "self-extension public exports include workspace isolation primitives for verifier integration"
      pattern: "createIsolatedWorktree"
---

<objective>
Establish reusable isolation, bounded execution, and diagnostics primitives for Phase 12 verifier work.

Purpose: SEXT-09/10/12 require deterministic isolation and structured failure contracts; this plan creates the shared building blocks before pipeline integration.
Output: New self-extension foundation modules for workspace lifecycle, bounded command execution, and diagnostics typing.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/12-isolated-sandbox-verification/12-RESEARCH.md
@packages/tools/src/self-extension/sandbox-runner.ts
@packages/tools/src/self-extension/staging-deployer.ts
@packages/tools/src/self-extension/tool-writer.ts
@packages/tools/src/self-extension/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement isolated worktree lifecycle utilities for candidate verification</name>
  <files>
    packages/tools/src/self-extension/workspace-isolation.ts
  </files>
  <action>
1. Add helper(s) to create and clean up ephemeral git worktrees rooted under a deterministic temp directory for each verification run.
2. Ensure helpers support:
   - selecting base ref/sha for worktree creation,
   - force cleanup on failure/interruption,
   - pruning stale worktree metadata.
3. Return structured errors (not raw shell text only) so the caller can classify infra/setup failures vs verification failures.
4. Keep all shell-outs routed through one command abstraction (introduced in Task 2), not ad hoc spawn logic.
  </action>
  <verify>
    - `pnpm --filter @jarvis/tools build` succeeds.
    - `rg -n "createIsolatedWorktree|cleanupIsolatedWorktree|git worktree" packages/tools/src/self-extension/workspace-isolation.ts` returns expected lifecycle implementation.
  </verify>
  <done>Self-extension code can reliably provision and clean isolated workspaces for candidate verification runs.</done>
</task>

<task type="auto">
  <name>Task 2: Add bounded subprocess runner with timeout and output limits</name>
  <files>
    packages/tools/src/self-extension/bounded-command.ts
  </files>
  <action>
1. Create a shared `runBoundedCommand` utility around `child_process.spawn` that enforces:
   - per-command timeout and hard-kill behavior,
   - bounded stdout/stderr capture (tail or byte limit),
   - deterministic exit status reporting (`pass`, `fail`, `timeout`, `error` classification inputs).
2. Include optional runtime knobs for Node-stage memory caps and environment overrides so later plans can enforce SEXT-10 resource bounds consistently.
3. Expose result metadata needed for diagnostics (`exitCode`, `durationMs`, stdout/stderr excerpts, timedOut flag, signal).
4. Keep shell invocation safety consistent with existing tooling (`shell: false` semantics).
  </action>
  <verify>
    - `pnpm --filter @jarvis/tools build` succeeds.
    - `rg -n "runBoundedCommand|timeout|killSignal|stdout|stderr" packages/tools/src/self-extension/bounded-command.ts` shows bounded runner semantics.
  </verify>
  <done>Verifier code has a single bounded command primitive that enforces timeout and output/resource policies.</done>
</task>

<task type="auto">
  <name>Task 3: Define typed verification diagnostics contract and export primitives</name>
  <files>
    packages/tools/src/self-extension/verification-diagnostics.ts
    packages/tools/src/self-extension/index.ts
  </files>
  <action>
1. Create a diagnostics model that captures run-level and stage-level outcomes with normalized fields:
   - stage name/status,
   - command/cwd metadata,
   - exit/timing/resource summaries,
   - failure category/reason.
2. Include helper(s) for constructing stage records from bounded-command outputs so downstream plans can reuse one schema.
3. Export diagnostics types/builders from self-extension index for use by verifier orchestration and builtin response shaping.
4. Keep schema machine-readable and stable so it can flow directly into tool output and future dashboard/audit surfaces.
  </action>
  <verify>
    - `pnpm --filter @jarvis/tools build` succeeds.
    - `rg -n "VerificationRunResult|VerificationStageResult|failureCategory" packages/tools/src/self-extension/verification-diagnostics.ts` returns typed diagnostics definitions.
    - `rg -n "verification-diagnostics" packages/tools/src/self-extension/index.ts` confirms exports.
  </verify>
  <done>Phase 12 has a reusable diagnostics contract ready for isolated verifier and staging integration.</done>
</task>

</tasks>

<verification>
- `pnpm --filter @jarvis/tools build`
- Confirm new exports are available from `packages/tools/src/self-extension/index.ts`
- Manual smoke: create/cleanup worktree helper invocation in a local sandbox path
</verification>

<success_criteria>
Isolation, bounded command execution, and diagnostics primitives exist in self-extension code and are ready to be consumed by the Phase 12 verifier pipeline.
</success_criteria>

<output>
After completion, create `.planning/phases/12-isolated-sandbox-verification/12-01-SUMMARY.md`
</output>
