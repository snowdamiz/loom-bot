---
phase: 12-isolated-sandbox-verification
plan: 03
type: execute
wave: 3
depends_on:
  - 12-02
files_modified:
  - apps/agent/src/index.ts
  - apps/agent/package.json
  - packages/tools/src/self-extension/isolated-verifier.ts
  - packages/tools/src/self-extension/staging-deployer.ts
  - packages/tools/src/self-extension/tool-writer.ts
  - README.md
autonomous: true
requirements:
  - SEXT-11
  - SEXT-12
must_haves:
  truths:
    - "Startup smoke verification can run deterministically and exit without entering the long-running autonomous loop."
    - "Tool responses for builtin verification failures expose structured stage diagnostics that operators and agent reasoning can consume."
    - "Phase 12 verification behavior is documented so blocked/failing states are understandable without code spelunking."
  artifacts:
    - path: "apps/agent/src/index.ts"
      provides: "Startup smoke mode that validates boot wiring and exits quickly"
      pattern: "startup smoke"
    - path: "packages/tools/src/self-extension/tool-writer.ts"
      provides: "Builtin modify payload includes structured verification diagnostics summary fields"
      pattern: "verification"
    - path: "README.md"
      provides: "Operator-facing documentation for isolated verifier stages and diagnostic outputs"
      pattern: "compile + targeted tests + startup smoke"
  key_links:
    - from: "apps/agent/package.json"
      to: "apps/agent/src/index.ts"
      via: "startup smoke script routes to deterministic smoke mode path"
      pattern: "startup:smoke"
    - from: "packages/tools/src/self-extension/staging-deployer.ts"
      to: "packages/tools/src/self-extension/tool-writer.ts"
      via: "staging verifier result is surfaced in builtin modify response payload"
      pattern: "verification"
    - from: "packages/tools/src/self-extension/isolated-verifier.ts"
      to: "apps/agent/package.json"
      via: "startup smoke stage invokes package script in isolated workspace"
      pattern: "startup:smoke"
---

<objective>
Finalize Phase 12 by delivering deterministic startup smoke checks and operator-usable structured diagnostics.

Purpose: SEXT-11 and SEXT-12 require a real startup smoke stage and actionable verification diagnostics in builtin modify outputs.
Output: Startup smoke command path, diagnostic payload propagation, and documentation updates.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/12-isolated-sandbox-verification/12-RESEARCH.md
@.planning/phases/12-isolated-sandbox-verification/12-02-PLAN.md
@apps/agent/src/index.ts
@apps/agent/package.json
@packages/tools/src/self-extension/isolated-verifier.ts
@packages/tools/src/self-extension/staging-deployer.ts
@packages/tools/src/self-extension/tool-writer.ts
@README.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add deterministic startup smoke mode for the agent package</name>
  <files>
    apps/agent/src/index.ts
    apps/agent/package.json
  </files>
  <action>
1. Add a startup smoke execution path (env flag or CLI argument) that validates critical boot wiring and exits quickly with explicit success/failure code.
2. Ensure smoke mode avoids entering long-running supervisor loop and avoids blocking on external readiness polls that are inappropriate for bounded verifier runs.
3. Add a dedicated package script (for example `startup:smoke`) that isolated verifier can invoke in candidate worktrees.
4. Keep default production startup path unchanged when smoke mode is not enabled.
  </action>
  <verify>
    - `pnpm --filter @jarvis/agent build` succeeds.
    - `pnpm --filter @jarvis/agent run startup:smoke` returns deterministic exit behavior in local/dev environment.
    - `rg -n "startup:smoke|smoke" apps/agent/package.json apps/agent/src/index.ts` confirms routing.
  </verify>
  <done>Agent package exposes a bounded startup smoke command suitable for isolated verification pipelines.</done>
</task>

<task type="auto">
  <name>Task 2: Wire startup smoke stage and full diagnostics propagation through verifier and staging</name>
  <files>
    packages/tools/src/self-extension/isolated-verifier.ts
    packages/tools/src/self-extension/staging-deployer.ts
    packages/tools/src/self-extension/tool-writer.ts
  </files>
  <action>
1. Update isolated verifier stage execution to include `startupSmoke` command using the new agent smoke script.
2. Ensure per-stage diagnostics include startup smoke command metadata, bounded output excerpts, status, and failure categorization.
3. Extend staging and builtin modify response contracts to surface verifier diagnostics summary fields (for example overall status, failed stage, diagnostic reference/snippets).
4. Maintain backward compatibility for callers by keeping existing fields while adding new structured verification fields.
  </action>
  <verify>
    - `pnpm --filter @jarvis/tools build` succeeds.
    - `pnpm --filter @jarvis/agent build` succeeds.
    - `rg -n "startupSmoke|verification|diagnostics" packages/tools/src/self-extension/isolated-verifier.ts packages/tools/src/self-extension/staging-deployer.ts packages/tools/src/self-extension/tool-writer.ts` confirms stage and payload wiring.
  </verify>
  <done>Startup smoke stage participates in required verification and failure details flow through builtin modify payloads in machine-readable form.</done>
</task>

<task type="auto">
  <name>Task 3: Update operator documentation for Phase 12 verification stages and diagnostics</name>
  <files>
    README.md
  </files>
  <action>
1. Document Phase 12 verifier behavior for builtin modify flow:
   - isolated workspace verification,
   - required stage sequence (compile, targeted tests, startup smoke),
   - fail-closed promotion behavior.
2. Document new diagnostic payload fields and how to interpret common failure categories/stages.
3. Add concise troubleshooting guidance for timeout/resource-bound failures and startup smoke-specific failures.
  </action>
  <verify>
    - `rg -n "isolated|compile|targeted|startup smoke|diagnostic" README.md` confirms updated guidance.
  </verify>
  <done>Repo documentation explains Phase 12 verification and diagnostics behavior clearly for operators and future development phases.</done>
</task>

</tasks>

<verification>
- `pnpm --filter @jarvis/tools build`
- `pnpm --filter @jarvis/agent build`
- Manual smoke: run builtin modify against a safe fixture and verify structured diagnostic fields on both pass and fail paths
</verification>

<success_criteria>
Startup smoke checks and structured diagnostics are fully integrated into builtin verification outputs, and docs describe expected behavior and troubleshooting.
</success_criteria>

<output>
After completion, create `.planning/phases/12-isolated-sandbox-verification/12-03-SUMMARY.md`
</output>
