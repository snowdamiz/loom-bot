---
phase: 13-promotion-guardrails-rollback-and-visibility
plan: 02
type: execute
wave: 2
depends_on:
  - 13-01
files_modified:
  - packages/tools/src/self-extension/rollback-controller.ts
  - packages/tools/src/self-extension/github-pipeline.ts
  - packages/tools/src/self-extension/staging-deployer.ts
  - packages/tools/src/self-extension/tool-writer.ts
  - packages/tools/src/self-extension/index.ts
  - apps/agent/src/recovery/self-extension-health.ts
  - apps/agent/src/multi-agent/supervisor.ts
  - apps/agent/src/index.ts
autonomous: true
requirements:
  - SEXT-13
  - SEXT-14
must_haves:
  truths:
    - "A known-good baseline is persisted and not advanced until post-promotion health checks pass."
    - "Startup or loop-health degradation within rollback window triggers automated rollback without manual git intervention."
    - "Rollback attempts and outcomes are recorded as append-only lifecycle events with deterministic reasons."
  artifacts:
    - path: "packages/tools/src/self-extension/rollback-controller.ts"
      provides: "Automated rollback orchestration from known-good baseline metadata"
      exports: ["runAutomatedRollback"]
    - path: "apps/agent/src/recovery/self-extension-health.ts"
      provides: "Post-promotion health monitoring and rollback trigger coordination"
      exports: ["startSelfExtensionHealthMonitor"]
    - path: "packages/tools/src/self-extension/github-pipeline.ts"
      provides: "Baseline transition and post-promotion health-window state updates"
      pattern: "known_good_baseline"
  key_links:
    - from: "apps/agent/src/multi-agent/supervisor.ts"
      to: "apps/agent/src/recovery/self-extension-health.ts"
      via: "loop heartbeat metadata feeds health monitor stale checks"
      pattern: "system:loop_health"
    - from: "apps/agent/src/recovery/self-extension-health.ts"
      to: "packages/tools/src/self-extension/rollback-controller.ts"
      via: "health monitor invokes rollback controller on failed health window"
      pattern: "runAutomatedRollback"
    - from: "packages/tools/src/self-extension/staging-deployer.ts"
      to: "packages/tools/src/self-extension/tool-writer.ts"
      via: "rollback status and baseline metadata propagate in builtin modify response contract"
      pattern: "rollback"
---

<objective>
Implement known-good baseline tracking and automated rollback when promoted changes degrade startup or loop health.

Purpose: SEXT-13 requires recoverability from bad promotions with deterministic automation and SEXT-14 requires rollback lifecycle observability.
Output: Rollback controller + post-promotion health monitor + response/state wiring for baseline and rollback outcomes.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/13-promotion-guardrails-rollback-and-visibility/13-RESEARCH.md
@.planning/phases/13-promotion-guardrails-rollback-and-visibility/13-01-PLAN.md
@packages/tools/src/self-extension/github-pipeline.ts
@packages/tools/src/self-extension/staging-deployer.ts
@packages/tools/src/self-extension/tool-writer.ts
@apps/agent/src/index.ts
@apps/agent/src/multi-agent/supervisor.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add post-promotion health telemetry and monitoring entrypoint in agent runtime</name>
  <files>
    apps/agent/src/recovery/self-extension-health.ts
    apps/agent/src/multi-agent/supervisor.ts
    apps/agent/src/index.ts
  </files>
  <action>
1. Add loop-health heartbeat persistence from supervisor loop (`agent_state` key such as `system:loop_health`) with timestamp, active-goal count, and loop status metadata.
2. Add a self-extension health monitor module that periodically evaluates pending promotion health windows and decides pass/fail outcomes using startup/loop-health signals.
3. Start the health monitor in agent startup after core services initialize, keeping it bounded and non-fatal to main process stability.
4. Ensure monitor behavior is deterministic and idempotent across restarts by reading persisted state keys instead of in-memory-only tracking.
  </action>
  <verify>
    - `pnpm --filter @jarvis/agent build` succeeds.
    - `rg -n "system:loop_health|startSelfExtensionHealthMonitor|health window" apps/agent/src/recovery/self-extension-health.ts apps/agent/src/multi-agent/supervisor.ts apps/agent/src/index.ts` confirms monitor + heartbeat wiring.
  </verify>
  <done>Agent runtime emits loop-health telemetry and runs a persistent health monitor for post-promotion rollback decisions.</done>
</task>

<task type="auto">
  <name>Task 2: Implement rollback controller and known-good baseline transition model</name>
  <files>
    packages/tools/src/self-extension/rollback-controller.ts
    packages/tools/src/self-extension/github-pipeline.ts
    packages/tools/src/self-extension/index.ts
  </files>
  <action>
1. Add rollback controller that restores previous known-good target from persisted baseline metadata and executes rollback via deterministic GitHub branch/PR/merge flow.
2. Add baseline lifecycle state handling in pipeline:
   - record previous baseline before promotion,
   - write `promoted_pending_health` state after merge success,
   - advance baseline only on health pass signal.
3. Ensure rollback execution records stage outcomes and reason metadata through lifecycle event helper.
4. Add idempotency/cooldown guards so repeated monitor ticks do not trigger duplicate rollback attempts for the same promotion window.
  </action>
  <verify>
    - `pnpm --filter @jarvis/tools build` succeeds.
    - `rg -n "runAutomatedRollback|known_good_baseline|promoted_pending_health|rollback_started|rolled_back" packages/tools/src/self-extension/rollback-controller.ts packages/tools/src/self-extension/github-pipeline.ts` confirms baseline + rollback flow.
  </verify>
  <done>Self-extension pipeline has deterministic rollback orchestration tied to a persisted known-good baseline model.</done>
</task>

<task type="auto">
  <name>Task 3: Wire rollback outcomes into staging/tool response contracts and lifecycle events</name>
  <files>
    packages/tools/src/self-extension/staging-deployer.ts
    packages/tools/src/self-extension/tool-writer.ts
  </files>
  <action>
1. Extend staging result contract with rollback-related fields (attempted, status, reason, target baseline sha, event references) while preserving existing compatibility.
2. Surface rollback status fields through builtin `tool_write` success/failure payloads so operators and autonomous logic can reason on recovery outcomes.
3. Emit append-only lifecycle events for rollback start/success/failure and failed health windows with normalized categories.
4. Ensure rollback-triggered failures remain fail-closed for further promotion attempts until state is healthy or operator intervenes.
  </action>
  <verify>
    - `pnpm --filter @jarvis/tools build` succeeds.
    - `rg -n "rollback|baseline|event" packages/tools/src/self-extension/staging-deployer.ts packages/tools/src/self-extension/tool-writer.ts` confirms response and event wiring.
  </verify>
  <done>Rollback automation outcomes are visible in tool responses and lifecycle audit history with deterministic fields.</done>
</task>

</tasks>

<verification>
- `pnpm --filter @jarvis/tools build`
- `pnpm --filter @jarvis/agent build`
- Manual smoke: simulate degraded post-promotion health state and confirm automated rollback trigger + lifecycle event entries
</verification>

<success_criteria>
Known-good baseline lifecycle and automated rollback are integrated, health-triggered, and auditable through append-only events.
</success_criteria>

<output>
After completion, create `.planning/phases/13-promotion-guardrails-rollback-and-visibility/13-02-SUMMARY.md`
</output>
