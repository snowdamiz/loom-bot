---
phase: 13-promotion-guardrails-rollback-and-visibility
plan: 03
type: execute
wave: 2
depends_on:
  - 13-01
files_modified:
  - apps/dashboard/src/routes/self-extension.ts
  - apps/dashboard/src/app.ts
  - apps/dashboard/src/poller.ts
  - apps/dashboard/client/src/hooks/useSSE.ts
  - apps/dashboard/client/src/hooks/useSelfExtensionStatus.ts
  - apps/dashboard/client/src/hooks/useAgentData.ts
  - apps/dashboard/client/src/components/SelfExtensionCard.tsx
  - apps/dashboard/client/src/components/OverviewTab.tsx
  - apps/dashboard/client/src/App.css
autonomous: true
requirements:
  - SEXT-15
  - SEXT-16
must_haves:
  truths:
    - "Dashboard/API exposes current self-extension pipeline health including latest PR/test/rollback outcome and promotion pause state."
    - "Operator can pause or resume self-extension promotion without toggling the global kill switch."
    - "Self-extension state updates are streamed to connected dashboard clients in near real time."
  artifacts:
    - path: "apps/dashboard/src/routes/self-extension.ts"
      provides: "Authenticated API for self-extension status reads and promotion pause toggles"
      exports: ["default"]
    - path: "apps/dashboard/src/poller.ts"
      provides: "SSE update emission including self-extension status payload"
      pattern: "self_extension"
    - path: "apps/dashboard/client/src/components/SelfExtensionCard.tsx"
      provides: "Operator-visible pipeline status card with promotion pause controls"
      pattern: "promotionPaused"
  key_links:
    - from: "apps/dashboard/src/routes/self-extension.ts"
      to: "packages/tools/src/self-extension/promotion-control.ts"
      via: "route reads/writes promotion control state and appends pause-change lifecycle events"
      pattern: "promotion_pause_changed"
    - from: "apps/dashboard/src/poller.ts"
      to: "apps/dashboard/client/src/hooks/useSSE.ts"
      via: "SSE event channel emits self-extension payload updates consumed by client cache"
      pattern: "self_extension"
    - from: "apps/dashboard/client/src/components/SelfExtensionCard.tsx"
      to: "apps/dashboard/src/routes/self-extension.ts"
      via: "pause/resume action calls API and refreshes pipeline status view"
      pattern: "/api/self-extension"
---

<objective>
Deliver operator-visible pipeline observability and promotion pause controls through dashboard API, SSE, and UI.

Purpose: SEXT-15 and SEXT-16 require explicit operator-facing visibility and independent promotion control flows.
Output: New self-extension dashboard route, SSE wiring, and overview UI card for status + pause/resume actions.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/13-promotion-guardrails-rollback-and-visibility/13-RESEARCH.md
@.planning/phases/13-promotion-guardrails-rollback-and-visibility/13-01-PLAN.md
@apps/dashboard/src/app.ts
@apps/dashboard/src/routes/status.ts
@apps/dashboard/src/poller.ts
@apps/dashboard/client/src/components/OverviewTab.tsx
@apps/dashboard/client/src/hooks/useSSE.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add backend self-extension status and promotion control routes</name>
  <files>
    apps/dashboard/src/routes/self-extension.ts
    apps/dashboard/src/app.ts
  </files>
  <action>
1. Add authenticated route module exposing:
   - `GET /api/self-extension` for current pipeline snapshot (latest promotion, verification, rollback, pause state),
   - `POST /api/self-extension/promotion` (or equivalent) to pause/resume promotion with validated reason/action payload.
2. Route pause/resume writes through promotion control helper and emit append-only pause-change lifecycle event.
3. Keep response payload machine-readable and stable for frontend + SSE consumers.
4. Mount route in dashboard app without changing existing auth middleware boundaries.
  </action>
  <verify>
    - `pnpm --filter @jarvis/dashboard build` succeeds.
    - `rg -n "GET /api/self-extension|promotion|paused|reason" apps/dashboard/src/routes/self-extension.ts` confirms contract and validation.
    - `rg -n "self-extension" apps/dashboard/src/app.ts` confirms route mount.
  </verify>
  <done>Dashboard backend exposes self-extension status and independent promotion pause/resume controls via authenticated API.</done>
</task>

<task type="auto">
  <name>Task 2: Extend SSE poller/client plumbing for self-extension status updates</name>
  <files>
    apps/dashboard/src/poller.ts
    apps/dashboard/client/src/hooks/useSSE.ts
    apps/dashboard/client/src/hooks/useSelfExtensionStatus.ts
  </files>
  <action>
1. Extend dashboard poller to fetch and emit a self-extension status payload on each poll cycle (or on state change when feasible).
2. Add client SSE handling for `self_extension` events and push updates into query cache/state used by the overview UI.
3. Add dedicated client hook for self-extension status fetch/query and cache invalidation behavior consistent with existing hooks.
4. Keep SSE parsing backward compatible with existing `status` and `activity` events.
  </action>
  <verify>
    - `pnpm --filter @jarvis/dashboard build` succeeds.
    - `pnpm --filter @jarvis/dashboard-client build` succeeds.
    - `rg -n "self_extension|self-extension" apps/dashboard/src/poller.ts apps/dashboard/client/src/hooks/useSSE.ts apps/dashboard/client/src/hooks/useSelfExtensionStatus.ts` confirms stream wiring.
  </verify>
  <done>Self-extension pipeline state updates flow from backend poller through SSE into client query state.</done>
</task>

<task type="auto">
  <name>Task 3: Add overview UI card for pipeline status and promotion pause controls</name>
  <files>
    apps/dashboard/client/src/components/SelfExtensionCard.tsx
    apps/dashboard/client/src/components/OverviewTab.tsx
    apps/dashboard/client/src/hooks/useAgentData.ts
    apps/dashboard/client/src/App.css
  </files>
  <action>
1. Implement a dedicated overview card showing:
   - promotion paused/running state,
   - latest PR/result summary,
   - latest verification and rollback outcomes with timestamps.
2. Add pause/resume action controls that call new backend endpoint, capture operator reason text, and refresh relevant cached queries.
3. Integrate card into overview layout while preserving existing status/kill-switch functionality and responsive behavior.
4. Keep UX deterministic for failure states (show API errors clearly, do not silently ignore toggle failures).
  </action>
  <verify>
    - `pnpm --filter @jarvis/dashboard-client build` succeeds.
    - `rg -n "SelfExtensionCard|promotionPaused|rollback" apps/dashboard/client/src/components/SelfExtensionCard.tsx apps/dashboard/client/src/components/OverviewTab.tsx` confirms UI integration.
    - Manual UI smoke: toggle pause/resume from dashboard and verify status reflects change without affecting kill-switch state.
  </verify>
  <done>Operator can view self-extension pipeline health and independently pause/resume promotion from the dashboard overview.</done>
</task>

</tasks>

<verification>
- `pnpm --filter @jarvis/dashboard build`
- `pnpm --filter @jarvis/dashboard-client build`
- Manual smoke: verify `/api/self-extension` response and overview card pause/resume interaction, including SSE-driven status refresh
</verification>

<success_criteria>
Self-extension pipeline status is visible in dashboard/API and operators can control promotion pause independently from the global kill switch.
</success_criteria>

<output>
After completion, create `.planning/phases/13-promotion-guardrails-rollback-and-visibility/13-03-SUMMARY.md`
</output>
