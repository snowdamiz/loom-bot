---
phase: 13-promotion-guardrails-rollback-and-visibility
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/db/src/schema/self-extension-events.ts
  - packages/db/src/schema/index.ts
  - packages/db/drizzle.config.ts
  - packages/tools/src/self-extension/lifecycle-events.ts
  - packages/tools/src/self-extension/promotion-control.ts
  - packages/tools/src/self-extension/github-pipeline.ts
  - packages/tools/src/self-extension/staging-deployer.ts
  - packages/tools/src/self-extension/index.ts
autonomous: true
requirements:
  - SEXT-14
  - SEXT-16
must_haves:
  truths:
    - "Every builtin self-modification lifecycle step writes append-only audit events with deterministic stage labels."
    - "Promotion pause state is persisted and evaluated independently from the global kill switch."
    - "Paused promotion attempts fail closed before GitHub branch/PR/merge actions execute."
  artifacts:
    - path: "packages/db/src/schema/self-extension-events.ts"
      provides: "Append-only self-extension lifecycle event ledger schema"
      exports: ["selfExtensionEvents"]
    - path: "packages/tools/src/self-extension/promotion-control.ts"
      provides: "Persistent promotion pause read/write helpers backed by agent_state"
      exports: ["getPromotionControlState", "setPromotionControlState"]
    - path: "packages/tools/src/self-extension/lifecycle-events.ts"
      provides: "Typed event emission helper used by self-extension pipeline modules"
      exports: ["appendSelfExtensionEvent"]
  key_links:
    - from: "packages/tools/src/self-extension/github-pipeline.ts"
      to: "packages/tools/src/self-extension/promotion-control.ts"
      via: "promotion control is checked before promotion operations and again before merge"
      pattern: "promotion-paused"
    - from: "packages/tools/src/self-extension/staging-deployer.ts"
      to: "packages/tools/src/self-extension/lifecycle-events.ts"
      via: "proposed/tested/failure events are emitted from staging lifecycle transitions"
      pattern: "appendSelfExtensionEvent"
    - from: "packages/db/drizzle.config.ts"
      to: "packages/db/src/schema/self-extension-events.ts"
      via: "schema list includes new append-only table for db push/generate"
      pattern: "self-extension-events"
---

<objective>
Build Phase 13 foundations: append-only lifecycle audit events and independent promotion pause controls.

Purpose: SEXT-14 and SEXT-16 require durable audit history and an operator-controlled promotion stop that does not halt the rest of agent activity.
Output: Event schema + lifecycle helper modules + fail-closed pause guard wired into self-extension pipeline.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/13-promotion-guardrails-rollback-and-visibility/13-RESEARCH.md
@.planning/phases/12-isolated-sandbox-verification/12-03-SUMMARY.md
@packages/db/src/schema/tool-calls.ts
@packages/db/src/schema/agent-state.ts
@packages/tools/src/self-extension/staging-deployer.ts
@packages/tools/src/self-extension/github-pipeline.ts
@packages/tools/src/self-extension/promotion-gate.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create append-only self-extension lifecycle event schema and wire DB exports</name>
  <files>
    packages/db/src/schema/self-extension-events.ts
    packages/db/src/schema/index.ts
    packages/db/drizzle.config.ts
  </files>
  <action>
1. Add a new self-extension lifecycle event table using append-only semantics (insert-only) with typed metadata fields and JSON payload support.
2. Include required event metadata for deterministic traceability: run/correlation id, stage/event type, actor source, goal/cycle/sub-goal references when available, and created timestamp.
3. Add comments documenting immutable usage expectations similar to existing append-only audit patterns.
4. Export the schema from `index.ts` and include it in `drizzle.config.ts` so `db:push` and generation include the table.
  </action>
  <verify>
    - `pnpm --filter @jarvis/db build` succeeds.
    - `rg -n "selfExtensionEvents|append-only|eventType|payload" packages/db/src/schema/self-extension-events.ts` confirms schema shape.
    - `rg -n "self-extension-events" packages/db/src/schema/index.ts packages/db/drizzle.config.ts` confirms export + config wiring.
  </verify>
  <done>Lifecycle audit events have a durable DB schema included in normal DB build/push flows.</done>
</task>

<task type="auto">
  <name>Task 2: Implement promotion control and lifecycle event helper modules</name>
  <files>
    packages/tools/src/self-extension/promotion-control.ts
    packages/tools/src/self-extension/lifecycle-events.ts
    packages/tools/src/self-extension/index.ts
  </files>
  <action>
1. Add promotion control helpers that persist and read promotion pause state from `agent_state` with explicit metadata (`paused`, `reason`, `updatedBy`, `updatedAt`).
2. Add a lifecycle event helper that inserts typed event rows into `self_extension_events` without update-in-place behavior.
3. Define canonical event names used in this phase (`proposed`, `tested`, `promotion_blocked`, `promoted`, `failed`, `promotion_pause_changed`) and keep payload contracts machine-readable.
4. Export new helpers from self-extension barrel index for use by staging, pipeline, dashboard routes, and later rollback logic.
  </action>
  <verify>
    - `pnpm --filter @jarvis/tools build` succeeds.
    - `rg -n "getPromotionControlState|setPromotionControlState|paused" packages/tools/src/self-extension/promotion-control.ts` confirms control helpers.
    - `rg -n "appendSelfExtensionEvent|promotion_blocked|promotion_pause_changed" packages/tools/src/self-extension/lifecycle-events.ts` confirms typed event emitter.
  </verify>
  <done>Reusable promotion control and lifecycle event primitives are available to self-extension and dashboard layers.</done>
</task>

<task type="auto">
  <name>Task 3: Enforce promotion pause guard and lifecycle event emission in staging/pipeline flow</name>
  <files>
    packages/tools/src/self-extension/staging-deployer.ts
    packages/tools/src/self-extension/github-pipeline.ts
  </files>
  <action>
1. Emit lifecycle events from key transitions:
   - staging proposed/tested outcomes,
   - promotion blocked reasons,
   - promotion success/failure.
2. Integrate promotion pause guard before GitHub promotion path and immediately before merge attempt; fail closed with deterministic block reason when paused.
3. Preserve existing response contracts (`promotionAttempted`, `promotionBlocked`, `blockReasons`, verification fields) while adding any new event references needed for traceability.
4. Ensure no GitHub mutation operations execute when pause guard blocks the run.
  </action>
  <verify>
    - `pnpm --filter @jarvis/tools build` succeeds.
    - `rg -n "appendSelfExtensionEvent|promotion-paused|promotion_blocked|promoted" packages/tools/src/self-extension/staging-deployer.ts packages/tools/src/self-extension/github-pipeline.ts` confirms guard + event wiring.
  </verify>
  <done>Self-extension promotion flow now supports fail-closed independent pause control and append-only event emission.</done>
</task>

</tasks>

<verification>
- `pnpm --filter @jarvis/db build`
- `pnpm --filter @jarvis/tools build`
- Manual smoke: run builtin modify while promotion pause is enabled and confirm blocked response + append-only event row
</verification>

<success_criteria>
Append-only lifecycle logging and independent promotion pause controls are implemented and integrated into the self-extension promotion path with fail-closed behavior.
</success_criteria>

<output>
After completion, create `.planning/phases/13-promotion-guardrails-rollback-and-visibility/13-01-SUMMARY.md`
</output>
